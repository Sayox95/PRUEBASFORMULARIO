<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reporte de Gastos de Combustible</title>

  <!-- Fuente opcional -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- Librerías necesarias -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script defer src="https://unpkg.com/blueimp-load-image/js/load-image.all.min.js"></script>

  <style>
    :root {
      --space: clamp(.75rem, 2.5vw, 1rem);
      --space-lg: clamp(1rem, 3.5vw, 1.25rem);
      --radius: 12px;
      --bg: #0b1020;
      --panel: #121a2b;
      --muted: #c9d3e0;
      --text: #eaf0f8;
      --primary: #4c9ffe;
      --danger: #ff5d7a;
      --ok: #19c37d;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: Roboto, system-ui, -apple-system, Segoe UI, sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 600px at 20% -10%, #14203a 0%, #0b1020 25%, #0b1020 100%);
      padding: var(--space);
    }
    header { max-width: 1024px; margin: 0 auto var(--space-lg); }
    h1 { font-size: clamp(1.25rem, 3.5vw, 1.75rem); margin: 0 0 .25rem; }
    p.sub { color: var(--muted); margin: 0; }

    .app { max-width: 1024px; margin: 0 auto; display: grid; gap: var(--space-lg); }

    .card {
      background: color-mix(in lab, var(--panel) 92%, #1d2b4a 8%);
      border: 1px solid color-mix(in lab, var(--panel) 85%, #4c9ffe 15%);
      border-radius: var(--radius);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      padding: var(--space-lg);
    }

    .grid { display: grid; gap: var(--space); }
    .grid.cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .grid.cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    @media (max-width: 900px) { .grid.cols-3 { grid-template-columns: 1fr; } }
    @media (max-width: 700px) { .grid.cols-2 { grid-template-columns: 1fr; } }

    label { font-weight: 600; display: block; margin-bottom: .35rem; }
    input, select, textarea, button {
      width: 100%;
      font-size: clamp(16px, 2.6vw, 18px);
      color: var(--text);
      background: #0f1525;
      border: 1px solid #223052;
      border-radius: .75rem;
      padding: .85rem 1rem;
      outline: none;
    }
    input::placeholder, textarea::placeholder { color: #8aa0bc; }
    input:focus-visible, select:focus-visible, textarea:focus-visible, button:focus-visible {
      outline: 3px solid var(--primary);
      outline-offset: 2px;
    }
    select { appearance: none; background-image: linear-gradient(45deg, transparent 50%, var(--muted) 50%), linear-gradient(135deg, var(--muted) 50%, transparent 50%);
      background-position: calc(100% - 20px) calc(1.1em), calc(100% - 15px) calc(1.1em);
      background-size: 5px 5px, 5px 5px; background-repeat: no-repeat; }

    .row { display: grid; grid-template-columns: 1fr auto; gap: var(--space); align-items: center; }

    .actions { display: flex; gap: .75rem; flex-wrap: wrap; }
    .btn { cursor: pointer; border-radius: 999px; padding: .9rem 1.25rem; border: 1px solid transparent; font-weight: 600; }
    .btn.primary { background: linear-gradient(180deg, #5fa8ff, #3578e5); }
    .btn.ghost { background: transparent; border-color: #2d3b5a; }
    .btn.ok { background: linear-gradient(180deg, #31d492, #0fa86b); }
    .btn.danger { background: linear-gradient(180deg, #ff7e96, #ff476a); }
    .btn[disabled] { opacity: .6; cursor: not-allowed; }

    .error { color: var(--danger); font-size: .9rem; margin-top: .25rem; min-height: 1.1em; }

    .previewWrap { border-radius: var(--radius); overflow: clip; border: 1px solid #213154; }
    #previewFrame { width: 100%; height: min(75vh, 900px); display: block; border: 0; background: #0a0f1e; }
    #previewFallback { padding: var(--space); }

    .thumbs { display: grid; gap: var(--space); grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); }
    .thumb { border: 1px dashed #335084; border-radius: .75rem; padding: .5rem; background: #0f172a; min-height: 160px; display: grid; place-items: center; }
    .thumb img { max-width: 100%; height: auto; object-fit: contain; display: block; }

    .toast { position: fixed; left: 50%; bottom: 24px; transform: translateX(-50%);
      background: #0f2a1f; border: 1px solid #1c7d57; color: #c8ffe7; padding: .85rem 1rem; border-radius: .75rem; box-shadow: 0 10px 20px rgba(0,0,0,.35); display: none; z-index: 50; }

    @media print {
      @page { size: letter; margin: 1.27cm; }
      body { background: white; color: black; }
      .no-print { display: none !important; }
    }
  </style>
</head>
<body>
  <header class="no-print">
    <h1>Reporte de Gastos de Combustible</h1>
    <p class="sub">Completa el formulario, previsualiza el PDF y envíalo. Compatible con móvil.</p>
  </header>

  <main class="app">
    <!-- FORMULARIO -->
    <section class="card" aria-labelledby="formTitle">
      <h2 id="formTitle" style="margin-top:0">Formulario</h2>
      <form id="form" novalidate class="grid">
        <div class="grid cols-3">
          <div>
            <label for="sector">Sector</label>
            <input id="sector" name="sector" placeholder="Ej. Norte" required />
            <div class="error" id="err_sector"></div>
          </div>
          <div>
            <label for="proceso">Proceso</label>
            <input id="proceso" name="proceso" placeholder="Ej. Recolección" required />
            <div class="error" id="err_proceso"></div>
          </div>
          <div>
            <label for="placa">Placa</label>
            <input id="placa" name="placa" placeholder="ABC-1234" required autocomplete="off" />
            <div class="error" id="err_placa"></div>
          </div>
        </div>

        <div class="grid cols-3">
          <div>
            <label for="nombre">Nombre</label>
            <input id="nombre" name="nombre" placeholder="Nombre completo" required />
            <div class="error" id="err_nombre"></div>
          </div>
          <div>
            <label for="identidad">Identidad</label>
            <input id="identidad" name="identidad" placeholder="0000-0000-00000" required pattern="\d{4}-\d{4}-\d{5}" />
            <div class="error" id="err_identidad"></div>
          </div>
          <div>
            <label for="jefe">Jefe inmediato</label>
            <input id="jefe" name="jefe" placeholder="Nombre jefe" />
            <div class="error" id="err_jefe"></div>
          </div>
        </div>

        <div class="grid cols-3">
          <div>
            <label for="fecha">Fecha</label>
            <input id="fecha" name="fecha" type="date" required />
            <div class="error" id="err_fecha"></div>
          </div>
          <div>
            <label for="horas">Horas del viaje</label>
            <input id="horas" name="horas" type="number" min="0" step="0.1" required />
            <div class="error" id="err_horas"></div>
          </div>
          <div>
            <label for="km">Km actual</label>
            <input id="km" name="km" type="number" min="0" step="1" required />
            <div class="error" id="err_km"></div>
          </div>
        </div>

        <div class="grid cols-3">
          <div>
            <label for="total">Total gastado (moneda)</label>
            <input id="total" name="total" type="number" min="0" step="0.01" required />
            <div class="error" id="err_total"></div>
          </div>
          <div>
            <label for="litros">Litros consumidos</label>
            <input id="litros" name="litros" type="number" min="0" step="0.01" required />
            <div class="error" id="err_litros"></div>
          </div>
          <div>
            <label for="motivo">Motivo del llenado</label>
            <input id="motivo" name="motivo" placeholder="Ej. Ruta diaria" required />
            <div class="error" id="err_motivo"></div>
          </div>
        </div>

        <div class="grid cols-3">
          <div>
            <label for="factura">Número de factura</label>
            <input id="factura" name="factura" required />
            <div class="error" id="err_factura"></div>
          </div>
          <div>
            <label for="nombre_comercio">Nombre del comercio</label>
            <input id="nombre_comercio" name="nombre_comercio" required />
            <div class="error" id="err_nombre_comercio"></div>
          </div>
          <div>
            <label for="sector_lista">Sector (lista opcional)</label>
            <select id="sector_lista" name="sector_lista">
              <option value="">Selecciona…</option>
              <option>Norte</option>
              <option>Sur</option>
              <option>Este</option>
              <option>Oeste</option>
            </select>
          </div>
        </div>

        <hr style="border-color:#223052; opacity:.5" />

        <div class="grid cols-3">
          <div>
            <label for="foto_tablero_antes">Foto tablero antes</label>
            <input id="foto_tablero_antes" type="file" accept="image/*" capture="environment" required />
            <div class="error" id="err_foto_tablero_antes"></div>
          </div>
          <div>
            <label for="foto_bomba">Foto bomba/contador</label>
            <input id="foto_bomba" type="file" accept="image/*" capture="environment" required />
            <div class="error" id="err_foto_bomba"></div>
          </div>
          <div>
            <label for="foto_despues">Foto tablero después</label>
            <input id="foto_despues" type="file" accept="image/*" capture="environment" required />
            <div class="error" id="err_foto_despues"></div>
          </div>
        </div>

        <div class="grid cols-3">
          <div>
            <label for="foto_bomba_llenado">Foto bomba llenado</label>
            <input id="foto_bomba_llenado" type="file" accept="image/*" capture="environment" required />
            <div class="error" id="err_foto_bomba_llenado"></div>
          </div>
          <div>
            <label for="foto_frontal">Foto frontal vehículo</label>
            <input id="foto_frontal" type="file" accept="image/*" capture="environment" required />
            <div class="error" id="err_foto_frontal"></div>
          </div>
          <div>
            <label for="foto_factura">Foto factura</label>
            <input id="foto_factura" type="file" accept="image/*" capture="environment" required />
            <div class="error" id="err_foto_factura"></div>
          </div>
        </div>

        <div class="thumbs">
          <div class="thumb" id="preview_foto_tablero_antes"><span>Preview tablero antes</span></div>
          <div class="thumb" id="preview_foto_bomba"><span>Preview bomba</span></div>
          <div class="thumb" id="preview_foto_despues"><span>Preview tablero después</span></div>
          <div class="thumb" id="preview_foto_bomba_llenado"><span>Preview bomba llenado</span></div>
          <div class="thumb" id="preview_foto_frontal"><span>Preview frontal</span></div>
          <div class="thumb" id="preview_foto_factura"><span>Preview factura</span></div>
        </div>

        <div class="actions">
          <button type="button" class="btn ghost no-print" id="btnPreview">Generar vista previa</button>
          <button type="button" class="btn primary no-print" id="btnEnviar">Enviar y descargar PDF</button>
          <button type="reset" class="btn danger no-print">Limpiar</button>
        </div>
      </form>
    </section>

    <!-- PREVIEW PDF -->
    <section class="card no-print" aria-labelledby="prevTitle">
      <h2 id="prevTitle" style="margin-top:0">Vista previa del PDF</h2>
      <div class="previewWrap">
        <iframe id="previewFrame" title="Vista previa del PDF"></iframe>
        <div id="previewFallback" hidden>
          <p>Tu navegador no puede mostrar el PDF embebido.</p>
          <div class="actions">
            <button id="btnAbrirPdf" class="btn ghost">Abrir PDF</button>
            <a id="linkDescargarPdf" class="btn ok" download>Descargar PDF</a>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite">Listo</div>

  <script>
    // ====== Estado en memoria ======
    const ImageState = {}; // { campoId: dataURL_base64_optimizado }
    let lastBlobUrl = null; // para revocar el preview previo

    // ====== Utils ======
    function showToast(msg = 'Hecho') {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.style.display = 'block';
      clearTimeout(showToast._timer);
      showToast._timer = setTimeout(()=>{ t.style.display = 'none'; }, 2500);
    }

    function setBusy(isBusy) {
      document.querySelectorAll('button').forEach(b => b.disabled = !!isBusy);
    }

    function pdfEmbedPodriaFallar() {
      const ua = navigator.userAgent;
      const iOS = /iPad|iPhone|iPod/.test(ua);
      const isSafari = /^((?!chrome|android).)*safari/i.test(ua);
      return iOS && isSafari;
    }

    function trimUpper(v) { return (v||'').trim().toUpperCase(); }
    function trimAny(v) { return (v||'').trim(); }

    // ====== Validación simple con Constraint Validation API ======
    function showError(input, text) {
      const e = document.getElementById('err_' + input.id);
      if (e) e.textContent = text || '';
    }
    function validateForm() {
      let ok = true;
      document.querySelectorAll('#form [required]').forEach(inp => {
        if (!inp.checkValidity()) {
          ok = false;
          showError(inp, inp.validationMessage);
        } else {
          showError(inp, '');
        }
      });
      // Validación extra para archivos + 48h
      const fileIds = ['foto_tablero_antes','foto_bomba','foto_despues','foto_bomba_llenado','foto_frontal','foto_factura'];
      for (const id of fileIds) {
        const el = document.getElementById(id);
        if (!el.files || !el.files[0]) { ok = false; showError(el, 'Requerido'); continue; }
        const file = el.files[0];
        const isRecent = (Date.now() - file.lastModified) <= (48 * 3600 * 1000); // 48h reales
        if (!isRecent) { ok = false; showError(el, 'La foto debe ser ≤ 48 horas'); }
      }
      return ok;
    }

    // ====== Imágenes: compresión previa con blueimp-load-image ======
    async function fileToOptimizedBase64(file, maxW = 1600, maxH = 1600, quality = 0.7) {
      return new Promise((resolve, reject) => {
        loadImage(
          file,
          (canvas) => {
            try {
              const mime = 'image/jpeg';
              const dataUrl = canvas.toDataURL(mime, quality);
              resolve(dataUrl);
            } catch (e) { reject(e); }
          },
          { canvas: true, orientation: true, maxWidth: maxW, maxHeight: maxH }
        );
      });
    }

    async function handleImageInput(inputId) {
      const input = document.getElementById(inputId);
      const file = input?.files?.[0];
      if (!file) { ImageState[inputId] = null; return; }

      // 48h check ya pasa en validateForm, pero también prevenimos aquí
      const isRecent = (Date.now() - file.lastModified) <= (48 * 3600 * 1000);
      if (!isRecent) { showError(input, 'La foto debe ser ≤ 48 horas'); input.value=''; return; }

      const optimized = await fileToOptimizedBase64(file, 1600, 1600, 0.7);
      ImageState[inputId] = optimized;

      requestAnimationFrame(() => {
        const prev = document.getElementById('preview_' + inputId);
        if (prev) prev.innerHTML = `<img alt="" src="${optimized}">`;
      });
    }

    ['foto_tablero_antes','foto_bomba','foto_despues','foto_bomba_llenado','foto_frontal','foto_factura']
      .forEach(id => {
        const el = document.getElementById(id);
        el?.addEventListener('change', () => handleImageInput(id), { passive: true });
      });

    // ====== Construcción del docDefinition (pdfMake) ======
    function buildDocDefinition(data, img) {
      const header = { text: 'Reporte de Gastos de Combustible', style: 'h1' };
      const info = {
        style: 'tableData',
        table: {
          widths: ['auto', '*', 'auto', '*'],
          body: [
            [{text:'Sector',bold:true}, data.Sector, {text:'Proceso',bold:true}, data.Proceso],
            [{text:'Placa',bold:true}, data.Placa, {text:'Fecha',bold:true}, data.Fecha],
            [{text:'Nombre',bold:true}, data.Nombre, {text:'Identidad',bold:true}, data.Identidad],
            [{text:'Jefe Inmediato',bold:true}, data.JefeInmediato || '-', {text:'Comercio',bold:true}, data.NombreComercio],
            [{text:'Factura',bold:true}, data.NumeroFactura, {text:'Horas viaje',bold:true}, data.HorasDelViaje],
            [{text:'Km actual',bold:true}, data.KmActual, {text:'Total',bold:true}, data.TotalGastado],
            [{text:'Litros',bold:true}, data.LitrosConsumidos, {text:'Motivo',bold:true}, data.MotivoDelLlenado],
          ]
        },
        layout: 'lightHorizontalLines'
      };

      const fotosTitle = { text: 'Evidencias fotográficas', style: 'h2', margin: [0, 10, 0, 6] };

      function imgOr(ph) { return img[ph] ? { image: img[ph], width: 230, margin: [0,5,0,5] } : { text: '—', color:'#666' }; }

      const fotos = {
        columns: [
          [ {text:'Tablero antes', style:'caption'}, imgOr('foto_tablero_antes') ],
          [ {text:'Bomba/contador', style:'caption'}, imgOr('foto_bomba') ],
          [ {text:'Tablero después', style:'caption'}, imgOr('foto_despues') ],
        ], columnGap: 10
      };

      const fotos2 = {
        columns: [
          [ {text:'Bomba llenado', style:'caption'}, imgOr('foto_bomba_llenado') ],
          [ {text:'Frontal vehículo', style:'caption'}, imgOr('foto_frontal') ],
          [ {text:'Factura', style:'caption'}, imgOr('foto_factura') ],
        ], columnGap: 10
      };

      return {
        pageSize: 'LETTER',
        pageMargins: [36, 36, 36, 36],
        content: [header, info, fotosTitle, fotos, fotos2],
        styles: {
          h1: { fontSize: 16, bold: true, margin: [0,0,0,8] },
          h2: { fontSize: 13, bold: true },
          caption: { fontSize: 10, italics: true, color: '#444' },
          tableData: { fontSize: 10 }
        },
        defaultStyle: { fontSize: 10 }
      };
    }

    // ====== Recolección de datos del formulario ======
    function getFormData() {
      const $ = id => document.getElementById(id);
      return {
        Sector: trimAny($('sector').value || $('sector_lista').value),
        Placa: trimUpper($('placa').value),
        Proceso: trimAny($('proceso').value),
        Nombre: trimAny($('nombre').value),
        Identidad: trimAny($('identidad').value),
        TotalGastado: trimAny($('total').value),
        LitrosConsumidos: trimAny($('litros').value),
        MotivoDelLlenado: trimAny($('motivo').value),
        Fecha: trimAny($('fecha').value),
        HorasDelViaje: trimAny($('horas').value),
        KmActual: trimAny($('km').value),
        NumeroFactura: trimAny($('factura').value),
        NombreComercio: trimAny($('nombre_comercio').value),
        JefeInmediato: trimAny(($('jefe').value) || '')
      };
    }

    // ====== Preview con pdfMake (Blob URL) ======
    function renderPdfPreview(docDefinition) {
      const iframe = document.getElementById('previewFrame');
      const fb = document.getElementById('previewFallback');
      const btnAbrir = document.getElementById('btnAbrirPdf');
      const linkDesc = document.getElementById('linkDescargarPdf');

      pdfMake.createPdf(docDefinition).getBlob((blob) => {
        if (lastBlobUrl) { URL.revokeObjectURL(lastBlobUrl); lastBlobUrl = null; }
        const blobUrl = URL.createObjectURL(blob);
        lastBlobUrl = blobUrl;
        if (pdfEmbedPodriaFallar()) {
          fb.hidden = false; iframe.style.display = 'none';
          btnAbrir.onclick = () => window.open(blobUrl, '_blank', 'noopener');
          linkDesc.href = blobUrl; linkDesc.download = 'reporte-preview.pdf';
        } else {
          fb.hidden = true; iframe.style.display = 'block';
          iframe.src = blobUrl;
        }
      });
    }

    // Debounce para regenerar preview manualmente
    let _previewTimer;
    function schedulePreview() {
      clearTimeout(_previewTimer);
      _previewTimer = setTimeout(async () => {
        try {
          const data = getFormData();
          const dd = buildDocDefinition(data, ImageState);
          renderPdfPreview(dd);
        } catch (e) { console.error(e); }
      }, 250);
    }

    // ====== Envío: guarda en backend + descarga local ======
    async function postJSONWithRetry(url, payload, retries=1, timeoutMs=10000) {
      const controller = new AbortController();
      const t = setTimeout(()=>controller.abort(), timeoutMs);
      try {
        const res = await fetch(url, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload), signal: controller.signal
        });
        clearTimeout(t);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const json = await res.json().catch(()=>({status:'OK'}));
        if (json.status && json.status !== 'OK') throw new Error(json.message||'Error lógico');
        return json;
      } catch (e) {
        clearTimeout(t);
        if (retries > 0) return postJSONWithRetry(url, payload, retries-1, timeoutMs);
        throw e;
      }
    }

    async function enviarReporte() {
      if (!validateForm()) { showToast('Completa los campos requeridos'); return; }
      setBusy(true);
      try {
        const data = getFormData();
        const dd = buildDocDefinition(data, ImageState);
        const filename = `${data.Sector||'sector'}_${data.Fecha||'fecha'}_${data.NumeroFactura||'factura'}.pdf`.replace(/\s+/g,'_');

        // 1) Base64 para backend
        await new Promise((resolve, reject) => {
          pdfMake.createPdf(dd).getBase64(async (b64) => {
            try {
              // Ajusta el endpoint a tu Apps Script / API
              await postJSONWithRetry('/api/guardar', { ...data, pdf: b64, filename }, 2, 12000);
              resolve();
            } catch (err) { reject(err); }
          });
        });

        // 2) Descarga local y preview sincronizado
        pdfMake.createPdf(dd).download(filename);
        renderPdfPreview(dd);
        showToast('Información enviada correctamente');
      } catch (e) {
        console.error(e);
        alert('Error al guardar el reporte. Inténtalo de nuevo.');
      } finally {
        setBusy(false);
      }
    }

    // ====== Eventos UI ======
    document.getElementById('btnPreview')?.addEventListener('click', schedulePreview);
    document.getElementById('btnEnviar')?.addEventListener('click', enviarReporte);

    // Regenerar preview cuando cambien campos clave (opcional)
    ['sector','sector_lista','proceso','placa','nombre','identidad','fecha','horas','km','total','litros','motivo','factura','nombre_comercio','jefe']
      .forEach(id => document.getElementById(id)?.addEventListener('change', schedulePreview));

    // Limpieza de Blob URL al salir
    window.addEventListener('beforeunload', () => { if (lastBlobUrl) URL.revokeObjectURL(lastBlobUrl); });
  </script>
</body>
</html>
