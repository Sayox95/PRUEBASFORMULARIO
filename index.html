<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reporte de Gastos de Combustible</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
  <script defer src="https://unpkg.com/blueimp-load-image/js/load-image.all.min.js"></script>
  <style>
    :root{--space:clamp(.75rem,2.5vw,1rem);--space-lg:clamp(1rem,3.5vw,1.25rem);--radius:12px;--muted:#c9d3e0;--text:#eaf0f8;--primary:#4c9ffe;--danger:#ff5d7a}
    *{box-sizing:border-box}
    body{margin:0;font-family:Roboto,system-ui,-apple-system,Segoe UI,sans-serif;color:var(--text);background:#0b1020;padding:var(--space)}
    header{max-width:1024px;margin:0 auto var(--space-lg)}
    h1{font-size:clamp(1.25rem,3.5vw,1.75rem);margin:0 0 .25rem}
    p.sub{color:var(--muted);margin:0}
    .app{max-width:1024px;margin:0 auto;display:grid;gap:var(--space-lg)}
    .card{background:#0f172a;border:1px solid #2a3a5a;border-radius:var(--radius);padding:var(--space-lg)}
    .grid{display:grid;gap:var(--space)}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.span-2{grid-column:1/-1}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:900px){.grid.cols-3{grid-template-columns:1fr}}
    @media (max-width:700px){.grid.cols-2{grid-template-columns:1fr}}
    label{font-weight:600;display:block;margin-bottom:.35rem}
    input,select,textarea,button{width:100%;font-size:clamp(16px,2.6vw,18px);color:var(--text);background:#0f1525;border:1px solid #223052;border-radius:.75rem;padding:.85rem 1rem;outline:none}
    input::placeholder,textarea::placeholder{color:#8aa0bc}
    input:focus-visible,select:focus-visible,textarea:focus-visible,button:focus-visible{outline:3px solid var(--primary);outline-offset:2px}
    select{appearance:none;background-image:linear-gradient(45deg,transparent 50%,var(--muted) 50%),linear-gradient(135deg,var(--muted) 50%,transparent 50%);background-position:calc(100% - 20px) calc(1.1em),calc(100% - 15px) calc(1.1em);background-size:5px 5px,5px 5px;background-repeat:no-repeat}
    .actions{display:flex;gap:.75rem;flex-wrap:wrap}
    .btn{cursor:pointer;border-radius:999px;padding:.9rem 1.25rem;border:1px solid #2d3b5a;font-weight:600;background:#0b1222}.picker-row .btn{font-size:.92rem;padding:.6rem 1rem}
    .btn.primary{background:#225ad6;color:#eaf0f8;border-color:#1c4bb3}
    .btn.ok{background:#0fa86b;border-color:#118a59}
    .btn.danger{background:#ff476a;border-color:#e33e5d}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .error{color:var(--danger);font-size:.9rem;margin-top:.25rem;min-height:1.1em}
    .previewWrap{border-radius:var(--radius);overflow:clip;border:1px solid #213154}
    #previewFrame{width:100%;height:min(75vh,900px);display:block;border:0;background:#0a0f1e}
    #previewFallback{padding:var(--space)}
    #pdfJsContainer{background:#f4f5f7; padding:12px; display:block;}
    .pdfjs-page{display:block;margin:0 auto 12px;max-width:100%;height:auto;image-rendering:-webkit-optimize-contrast;image-rendering:crisp-edges;}
    .thumbs{display:grid;gap:var(--space);grid-template-columns:repeat(auto-fill,minmax(180px,1fr))}
    .thumb{border:1px dashed #335084;border-radius:.75rem;padding:.5rem;background:#0f172a;min-height:160px;display:grid;place-items:center}
    .thumb img{max-width:100%;height:auto;object-fit:contain;display:block}
    .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#0f2a1f;border:1px solid #1c7d57;color:#c8ffe7;padding:.85rem 1rem;border-radius:.75rem;box-shadow:0 10px 20px rgba(0,0,0,.35);display:none;z-index:50}
    @media print{@page{size:letter;margin:1.27cm}body{background:#fff;color:#000}.no-print{display:none !important}}
      .progressBarWrap{width:260px;height:8px;background:#1e2a44;border-radius:999px;overflow:hidden;border:1px solid #2a3a5a}
    .progressBar{height:100%;width:0%;background:#4c9ffe}
  
/* === Estado validación factura === */
.factura-status{display:inline-flex;align-items:center;gap:.5rem;margin-left:.5rem;font-size:.9rem;font-weight:600}
.factura-status.ok{color:#0b8a3a}
.factura-status.err{color:#b00020}
.factura-status.warn{color:#b26a00}
.factura-status.mute{color:#6b7280}

}


/* Spinner con pseudo-elemento (robusto) */
.factura-status{font-size:.9rem;font-weight:600;margin-left:.5rem;vertical-align:middle}
.factura-status.ok{color:#16a34a}
.factura-status.err{color:#ef4444}
.factura-status.warn{color:#f59e0b}
.factura-status.loading{color:#64748b;position:relative;padding-left:1.4rem}
.factura-status.loading::before{
  content:"";width:1rem;height:1rem;border-radius:50%;
  border:.18rem solid #cbd5e1;border-top-color:#334155;
  position:absolute;left:0;top:50%;transform:translateY(-50%);
  animation:factura-spin 1s linear infinite;
}
@keyframes factura-spin{to{transform:translateY(-50%) rotate(360deg);}}


.form-grid textarea{width:100%; min-height:3.25rem; padding:0.5rem; border:1px solid #cbd5e1; border-radius:0.5rem;}
</style>
</head>
<body>
  <header class="no-print">
    <h1>Reporte de Gastos de Combustible</h1>
    <p class="sub">Completa el formulario, previsualiza el PDF y envíalo. Compatible con móvil.</p>
  </header>
  <main class="app">
    <section class="card" aria-labelledby="formTitle">
      <h2 id="formTitle" style="margin-top:0">Formulario</h2>
      <form id="form" novalidate class="grid">
        <div class="grid cols-3">
          <div>
            <label for="sector">Sector</label>
            <select id="sector" name="sector" required disabled>
              <option value="">Cargando…</option>
            </select>
            <div class="error" id="err_sector"></div>
          </div>
          <div>
            <label for="proceso">Proceso</label>
<select id="proceso" name="proceso" required>
  <option value="" selected disabled>Cargando procesos…</option>
</select>

            <div class="error" id="err_proceso"></div>
          </div>
          <div>
            <label for="placa">Placa</label>
            <select id="placa" name="placa" required disabled>
              <option value="">Selecciona…</option>
            </select>
            <div class="error" id="err_placa"></div>
          </div>
        </div>
        <div class="grid cols-3">
          <div>
            <label for="nombre">Nombre</label>
            <input id="nombre" name="nombre" placeholder="Nombre completo" required />
            <div class="error" id="err_nombre"></div>
          </div>
          <div>
            <label for="identidad">Identidad</label> <span id=\"err_identidad_lbl\" class=\"hint\" style=\"margin-left:.5rem;font-size:.9em;color:#b45309\"></span>
            <input id="identidad" name="identidad" placeholder="0000-0000-00000" required pattern="\d{4}-\d{4}-\d{5}" />
            <div class="error" id="err_identidad"></div>
          </div>
          <div>
            <label for="jefe">Jefe inmediato</label>
            <input id="jefe" name="jefe" placeholder="Nombre jefe" readonly />
            <div class="error" id="err_jefe"></div>
          </div>
        </div>
        <div class="grid cols-3">
          <div>
            <label for="fecha">Fecha</label>
            <input id="fecha" name="fecha" type="date" required />
            <div class="error" id="err_fecha"></div>
          </div>
          <div>
            <label for="horas">Horas del viaje</label>
            <input id="horas" name="horas" type="number" min="0" step="0.1" required />
            <div class="error" id="err_horas"></div>
          </div>
          <div>
            <label for="km">Km actual</label>
            <input id="km" name="km" type="number" min="0" step="1" required />
            <div class="error" id="err_km"></div>
          </div>
        </div>
        <div class="grid cols-3">
          <div>
            <label for="total">Total gastado (moneda)</label> <span id="err_total_lbl" class="hint" style="margin-left:.5rem;font-size:.9em;color:#b45309"></span>
            <input id="total" name="total" type="text" min="0" step="0.01" required / inputmode="decimal">
            <div class="error" id="err_total"></div>
          </div>
          <div>
            <label for="litros">Litros consumidos</label> <span id="err_litros_lbl" class="hint" style="margin-left:.5rem;font-size:.9em;color:#b45309"></span>
            <input id="litros" name="litros" type="text" min="0" step="0.01" required / inputmode="decimal">
            <div class="error" id="err_litros"></div>
          </div>
          <div class="span-2">
            <label for="motivo">Motivo del llenado</label>
            <textarea  id="motivo" name="motivo" placeholder="Ej. Ruta diaria" required / rows="4" placeholder="Explique brevemente..." style="resize:vertical"></textarea>
            <div class="error" id="err_motivo"></div>
          </div>
        </div>
        <div class="grid cols-3">
          <div>
            <label for="factura">Número de factura <span id="facturaStatus" class="factura-status" aria-live="polite"></span></label>
            <input id="factura" name="factura" required />
            <div class="error" id="err_factura"></div>
          </div>
          <div>
            <label for="nombre_comercio">Nombre del comercio</label>
            <input id="nombre_comercio" name="nombre_comercio" required />
            <div class="error" id="err_nombre_comercio"></div>
          </div>
</div>
        <hr style="border-color:#223052;opacity:.5" />
        <div class="grid cols-3">
          <div>
            <label for="foto_tablero_antes">Foto tablero antes</label>
            <div class="picker-row"><button type="button" id="cam_foto_tablero_antes" class="btn btn-sm">Tomar foto</button> <button type="button" id="gal_foto_tablero_antes" class="btn btn-sm">Elegir de galería</button></div>
<input id="foto_tablero_antes" type="file" accept="image/*" style="display:none" required />
            <div class="error" id="err_foto_tablero_antes"></div>
          <div class="thumb" id="preview_foto_tablero_antes"><span>Preview tablero antes</span></div>
</div>
          <div>
            <label for="foto_bomba">Foto bomba/contador</label>
            <div class="picker-row"><button type="button" id="cam_foto_bomba" class="btn btn-sm">Tomar foto</button> <button type="button" id="gal_foto_bomba" class="btn btn-sm">Elegir de galería</button></div>
<input id="foto_bomba" type="file" accept="image/*" style="display:none" required />
            <div class="error" id="err_foto_bomba"></div>
          <div class="thumb" id="preview_foto_bomba"><span>Preview bomba</span></div>
</div>
          <div>
            <label for="foto_despues">Foto tablero después</label>
            <div class="picker-row"><button type="button" id="cam_foto_despues" class="btn btn-sm">Tomar foto</button> <button type="button" id="gal_foto_despues" class="btn btn-sm">Elegir de galería</button></div>
<input id="foto_despues" type="file" accept="image/*" style="display:none" required />
            <div class="error" id="err_foto_despues"></div>
          <div class="thumb" id="preview_foto_despues"><span>Preview tablero después</span></div>
</div>
        </div>
        <div class="grid cols-3">
          <div>
            <label for="foto_bomba_llenado">Foto bomba llenado</label>
            <div class="picker-row"><button type="button" id="cam_foto_bomba_llenado" class="btn btn-sm">Tomar foto</button> <button type="button" id="gal_foto_bomba_llenado" class="btn btn-sm">Elegir de galería</button></div>
<input id="foto_bomba_llenado" type="file" accept="image/*" style="display:none" required />
            <div class="error" id="err_foto_bomba_llenado"></div>
          <div class="thumb" id="preview_foto_bomba_llenado"><span>Preview bomba llenado</span></div>
</div>
          <div>
            <label for="foto_frontal">Foto frontal vehículo</label>
            <div class="picker-row"><button type="button" id="cam_foto_frontal" class="btn btn-sm">Tomar foto</button> <button type="button" id="gal_foto_frontal" class="btn btn-sm">Elegir de galería</button></div>
<input id="foto_frontal" type="file" accept="image/*" style="display:none" required />
            <div class="error" id="err_foto_frontal"></div>
          <div class="thumb" id="preview_foto_frontal"><span>Preview frontal</span></div>
</div>
          <div>
            <label for="foto_factura">Foto factura</label>
            <div class="picker-row"><button type="button" id="cam_foto_factura" class="btn btn-sm">Tomar foto</button> <button type="button" id="gal_foto_factura" class="btn btn-sm">Elegir de galería</button></div>
<input id="foto_factura" type="file" accept="image/*" style="display:none" required />
            <div class="error" id="err_foto_factura"></div>
          <div class="thumb" id="preview_foto_factura"><span>Preview factura</span></div>
</div>
        </div>
        <div class="actions">
          <button type="button" class="btn" id="btnPreview" disabled>Generar vista previa</button>
          <button type="button" class="btn primary" id="btnEnviar" disabled>Enviar y descargar PDF</button>
          <button type="reset" class="btn danger">Limpiar</button>
        </div>
      </form>
    </section>

    <section class="card no-print" aria-labelledby="prevTitle">
      <h2 id="prevTitle" style="margin-top:0">Vista previa del PDF</h2>
      <div class="previewWrap">
        <iframe id="previewFrame" title="Vista previa del PDF"></iframe>
        <div id="pdfJsContainer" hidden></div>
        <div id="previewFallback" hidden>
          <p>Tu navegador no puede mostrar el PDF embebido.</p>
          <div class="actions">
            <button id="btnAbrirPdf" class="btn">Abrir</button>
            <a id="linkDescargarPdf" class="btn ok" download>Descargar PDF</a>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite">Listo</div>

  <div id="progressToast" class="toast" style="display:none" hidden>
    <div id="progressLabel" style="margin-bottom:6px">Guardando información...</div>
    <div class="progressBarWrap"><div id="progressBar" class="progressBar" style="width:0%"></div></div>
  </div>
  <script>
  (function(){
    'use strict';

    const ImageState = {};
    let isSaving = false;
    const urlGuardarReporte = '/api/guardar';
    const Catalogos = { sectores: [], placasPorSector: {}, jefePorSector: {} };
    const urlCatalogos = 'https://script.google.com/macros/s/AKfycbxp2yVp4hF-t9f2LdU9NhZxVt6RwXyL3uKrKzXk4a_l4na2Rkd1LZMB02pEJeRQ_eCF/exec';

    function $(id){ return document.getElementById(id); }
    function showToast(msg){ const t=$('toast'); if(!t) return; t.textContent=msg||'Hecho'; t.style.display='block'; clearTimeout(showToast._t); showToast._t=setTimeout(()=>{ t.style.display='none'; }, 2500); }
    function setBusy(b){ document.querySelectorAll('button').forEach(x=>x.disabled=!!b); }

    function showError(input,text){ const e=$('err_'+input.id); if(e) e.textContent=text||''; }
    function trimUpper(v){ return (v||'').trim().toUpperCase(); }
    function trimAny(v){ return (v||'').trim(); }

    // Normaliza números con separadores a formato '1234.56' para guardar
    
    function normalizeNumberForSave(v){
      v = (v==null) ? '' : String(v);
      v = v.replace(/\s+/g, '');
      v = v.replace(/,/g,''); // quitar comas
      var first = v.indexOf('.');
      if (first !== -1){
        var intPart = v.slice(0, first).replace(/\./g,'');
        var fracPart = v.slice(first+1).replace(/\./g,'');
        return intPart + (fracPart ? ('.' + fracPart) : '');
      }
      return v.replace(/\./g,''); // solo enteros
    }
    
    
    function pdfEmbedPodriaFallar(){
      const ua=navigator.userAgent||navigator.vendor||'';
      const iOS=/iPad|iPhone|iPod/i.test(ua);
      const isSafari=/^((?!chrome|android).)*safari/i.test(ua);
      const isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);
      return (iOS && isSafari) || isMobile;
    }

    function showProgress(label){ const t=$('progressToast'),l=$('progressLabel'); if(!t||!l) return; l.textContent=label||'Guardando información...'; t.hidden=false; t.style.display='block'; setProgress(10); clearInterval(showProgress._timer); showProgress._timer=setInterval(()=>{ const b=$('progressBar'); const curr=parseInt(b&&b.style && b.style.width ? b.style.width : '0')||0; if(curr<85) setProgress(curr+5); },400); }
    function setProgress(p){ const b=$('progressBar'); if(b){ const v=Math.max(0,Math.min(100,Number(p)||0)); b.style.width=v+'%'; } }
    function hideProgress(msg){ const t=$('progressToast'),b=$('progressBar'); clearInterval(showProgress._timer); setProgress(100); setTimeout(()=>{ if(t){ t.style.display='none'; t.hidden=true; } if(b) b.style.width='0%'; if(msg) showToast(msg); },300); }

    function readFileAsDataURL(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=()=>rej(fr.error||new Error('FileReader')); fr.readAsDataURL(file); }); }
    function drawToCanvas(imgLike,maxW,maxH){ const iw=imgLike.naturalWidth||imgLike.width; const ih=imgLike.naturalHeight||imgLike.height; const r=Math.min(maxW/iw,maxH/ih,1); const tw=Math.max(1,Math.round(iw*r)); const th=Math.max(1,Math.round(ih*r)); const c=document.createElement('canvas'); c.width=tw; c.height=th; const ctx=c.getContext('2d'); ctx.drawImage(imgLike,0,0,tw,th); return c; }
    const SUPPORTED_IMAGE_TYPES=new Set(['image/jpeg','image/png','image/webp']);
    async function fileToOptimizedBase64(file,maxW=1280,maxH=1280,quality=0.6){ if(!file) throw new Error('Archivo inválido'); if(!SUPPORTED_IMAGE_TYPES.has(file.type)){ const e=new Error('Formato no soportado'); e.code='UNSUPPORTED_FORMAT'; e.type=file.type||'unknown'; throw e; } const dataUrl=await readFileAsDataURL(file); const img=await new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=dataUrl; }); const canvas=drawToCanvas(img,maxW,maxH); return canvas.toDataURL('image/jpeg',quality); }

    async function handleImageInput(inputId){ const input=$(inputId); const file=input&&input.files&&input.files[0]; if(!file){ ImageState[inputId]=null; return; } const isRecent=(Date.now()-file.lastModified)<=48*3600*1000; if(!isRecent){ showError(input,'La foto debe ser ≤ 48 horas'); input.value=''; return; } try{ const optimized=await fileToOptimizedBase64(file, 1280, 1280, 0.6); ImageState[inputId]=optimized; requestAnimationFrame(()=>{ const prev=$('preview_'+inputId); if(prev) prev.innerHTML='<img alt="" src="'+optimized+'">'; }); }catch(err){ if(err&&err.code==='UNSUPPORTED_FORMAT') showError(input,'Formato no soportado ('+(err.type||'')+'). Usa JPG/PNG/WebP.'); else showError(input,'No se pudo leer la imagen'); } }

    function validateForm(){ let ok=true; document.querySelectorAll('#form [required]').forEach(inp=>{ if(!inp.checkValidity()){ ok=false; showError(inp, inp.validationMessage); } else { showError(inp,''); } }); const ids=['foto_tablero_antes','foto_bomba','foto_despues','foto_bomba_llenado','foto_frontal','foto_factura']; for(const id of ids){ const el=$(id); if(!el.files||!el.files[0]){ ok=false; showError(el,'Requerido'); continue; } const f=el.files[0]; const recent=(Date.now()-f.lastModified)<=48*3600*1000; if(!recent){ ok=false; showError(el,'La foto debe ser ≤ 48 horas'); } } return ok; }

    function getFormData(){ return { Sector: trimAny($('sector').value), Placa: trimUpper($('placa').value), Proceso: trimAny($('proceso').value), Nombre: trimAny($('nombre').value), Identidad: trimAny($('identidad').value), TotalGastado: normalizeNumberForSave($('total').value), LitrosConsumidos: normalizeNumberForSave($('litros').value), MotivoDelLlenado: trimAny($('motivo').value), Fecha: trimAny($('fecha').value), HorasDelViaje: trimAny($('horas').value), KmActual: trimAny($('km').value), NumeroFactura: trimAny($('factura').value), NombreComercio: trimAny($('nombre_comercio').value), JefeInmediato: trimAny(($('jefe').value)||'') }; }

    function waitForPdfMake(timeout){ timeout=timeout||12000; return new Promise(function(resolve,reject){ var t0=Date.now(); (function check(){ if(window.pdfMake && typeof window.pdfMake.createPdf==='function') return resolve(window.pdfMake); if(Date.now()-t0>timeout) return reject(new Error('pdfMake no cargó')); setTimeout(check,30); })(); }); }

    function base64ToUint8Array(base64){ var bin=atob(base64); var len=bin.length; var bytes=new Uint8Array(len); for(var i=0;i<len;i++) bytes[i]=bin.charCodeAt(i); return bytes; }

    function buildDocDefinition(data,img){
  if (typeof window!=='undefined' && window.__logoBase64 && img && !img.logo) { img.logo = window.__logoBase64; }

      var hasLogo=!!img.logo;
      
var header = {
  table: {
    widths: [ 160, '*', 70, 90],
    body: [
      [
        (img.logo
          ? { rowSpan: 3, image: img.logo, fit:[140,40], alignment:'center', margin:[0,6,0,6] }
          : { rowSpan: 3, text:'UTCD', style:'tH1', alignment:'center', margin:[0,8,0,8] }),
        { rowSpan: 3, text:'DETALLE DE LA FACTURA DE COMBUSTIBLE', style:'tH1', bold:true, alignment:'center', margin:[0,10,0,10] },
        { text:'Código', bold:true, alignment:'center' },
        { text:String(data.Codigo||'CLS-PAU-F-19'), alignment:'center' }
      ],
      [
        '', '',
        { text:'Versión', bold:true, alignment:'center' },
        { text:String(data.Version||'1'), alignment:'center' }
      ],
      [
        '', '',
        { text:'Fecha', bold:true, alignment:'center' },
        { text:'20/5/2025', alignment:'center' }
      ]
    ]
  },
  layout: {
    hLineWidth: function(){return 1;},
    vLineWidth: function(){return 1;},
    hLineColor: function(){return '#243045';},
    vLineColor: function(){return '#243045';},
    paddingLeft: function(){return 6;},
    paddingRight: function(){return 6;},
    paddingTop: function(){return 4;},
    paddingBottom: function(){return 4;}
  },
  margin:[0,0,0,8]
};


      var infoTable={ style:'tCampos', table:{ widths:[100,165], heights:function(row){ return row===5?110:(row===2||row===10?48:38); }, body:[ [{text:'Nombre Completo',style:'lbl'},data.Nombre||'' ], [{text:'No. Identidad',style:'lbl'},data.Identidad||'' ], [{text:'Firma del Colaborador',style:'lbl'},{text:'', margin:[0,10,0,6]}], [{text:'Tipo de Gestión',style:'lbl'},'Liquidación de gastos de combustible' ], [{text:'Total',style:'lbl'},(data.LitrosConsumidos?(String(data.LitrosConsumidos)+' L'):'') ], [{text:'Motivo del llenado de combustible',style:'lbl'}, { stack: [ {text:'Compra de Combustible al Vehículo', margin:[0,0,0,5]}, {text:['Para Labores de: ',{text:(data.ParaLabores||'')}], margin:[0,4,0,0]}, {text:(data.MotivoDelLlenado||''), margin:[0,4,0,0]}, {text:['Proceso: ',{text:(data.Proceso||'')}], margin:[0,4,0,0]} ] } ], [{text:'Fecha',style:'lbl'},data.Fecha||'' ], [{text:'Placa o VIN',style:'lbl'},data.Placa||'' ], [{text:'Observación',style:'lbl'},{stack:[{text:'SECTOR: '+(data.Sector||'')},{text:'KM: '+(data.KmActual||'')},{text:'FACTURA: '+(data.NumeroFactura||'')}]}], [{text:'Autorizado por Jefe Inmediato',style:'lbl'},(data.JefeInmediato||'') ], [{text:'Firma',style:'lbl'},{text:'', margin:[0,10,0,6]}] ] }, layout:{hLineWidth:function(){return 1},vLineWidth:function(){return 1},hLineColor:'#000',vLineColor:'#000',paddingLeft:function(){return 4},paddingRight:function(){return 4},paddingTop:function(){return 3},paddingBottom:function(){return 3}} };

      var cuadroFacturaGuia={ table:{widths:[230],body:[[{text:'Pegar Factura Original en este Espacio',alignment:'center',italics:true,color:'#666'}]]}, layout:{hLineWidth:function(){return 1},vLineWidth:function(){return 1},hLineColor:'#000',vLineColor:'#000',paddingLeft:function(){return 6},paddingRight:function(){return 6},paddingTop:function(){return 300},paddingBottom:function(){return 300}}, margin:[0,6,10,0] };

      var page1={ stack:[ header, { columns:[ {width:230,stack:[cuadroFacturaGuia]}, {width:'*',stack:[infoTable],margin:[0,6,12,0]} ], columnGap:26 } ], pageBreak:'after' };

// === Helper: reformat 'Observación' value into multi-line Sector/KM/Factura ===
function _reformatObservacion(node, data){
  if (!node || typeof node !== 'object') return;
  try{
    if (node.table && Array.isArray(node.table.body)){
      for (const row of node.table.body){
        if (Array.isArray(row)){
          for (let i=0;i<row.length;i++){
            const cell = row[i];
            const label = cell && (cell.text || cell.stack && cell.stack[0] && cell.stack[0].text);
            if (label && (label === 'Observación' || label === 'Observacion')){
              // next cell holds the original text; replace with multiline text
              const valCellIdx = i+1;
              if (row[valCellIdx] !== undefined){
                row[valCellIdx] = {
                  stack: [
    { text: 'Sector: ' + String(data.Sector||''),  margin:[0,0,0,5] },
    { text: 'KM: '     + String(data.KmActual||''), margin:[0,0,0,5] },
    { text: 'Factura: '+ String(data.NumeroFactura||'') }
  ]
                };
              }
            }
          }
        }
      }
    }
    if (Array.isArray(node.stack)) node.stack.forEach(n => _reformatObservacion(n, data));
    if (Array.isArray(node.columns)) node.columns.forEach(n => _reformatObservacion(n, data));
  }catch(_){}
}

_reformatObservacion(page1, data);


      function fotoCard(titulo,phKey){ return { stack:[ {text:titulo,style:'fotoLbl',alignment:'center',margin:[0,0,0,5]}, (img[phKey]?{image:img[phKey],width:170,alignment:'center'}:{text:'-',color:'#666',alignment:'center',margin:[0,30,0,30]}) ] }; }

      
var page2 = {
  stack: [
    { text: 'FOTOGRAFÍAS', style: 'tSub', alignment: 'center', margin:[0,0,0,8] },
    {
      table: {
        widths: [260, 260],
        body: [
          [
            {
              stack: [
                { text:'TABLERO ANTES DE LLENADO', style:'tSub', alignment:'center', margin:[0,0,0,5] },
                (img['foto_tablero_antes']
                  ? { image: img['foto_tablero_antes'], fit: [230, 180], alignment:'center' }
                  : { text:'-', alignment:'center', color:'#666', margin:[0,60,0,60] })
              ]
            },
            {
              stack: [
                { text:'BOMBA DE COMBUSTIBLE 0', style:'tSub', alignment:'center', margin:[0,0,0,5] },
                (img['foto_bomba']
                  ? { image: img['foto_bomba'], fit: [230, 180], alignment:'center' }
                  : { text:'-', alignment:'center', color:'#666', margin:[0,60,0,60] })
              ]
            }
          ],
          [
            {
              stack: [
                { text:'TABLERO DESPUÉS DE LLENADO', style:'tSub', alignment:'center', margin:[0,0,0,5] },
                (img['foto_despues']
                  ? { image: img['foto_despues'], fit: [230, 180], alignment:'center' }
                  : { text:'-', alignment:'center', color:'#666', margin:[0,60,0,60] })
              ]
            },
            {
              rowSpan: 2,
              stack: [
                { text:'VISTA FRONTAL DEL VEHÍCULO / VIN CON VEHICULO', style:'tSub', alignment:'center', margin:[0,0,0,5] },
                (img['foto_frontal']
                  ? { image: img['foto_frontal'], fit: [230, 180], alignment:'center' }
                  : { text:'-', alignment:'center', color:'#666', margin:[0,60,0,60] })
              ]
            }
          ],
          [
            {
              stack: [
                { text:'BOMBA DE COMBUSTIBLE LLENA', style:'tSub', alignment:'center', margin:[0,0,0,5] },
                (img['foto_bomba_llenado']
                  ? { image: img['foto_bomba_llenado'], fit: [230, 180], alignment:'center' }
                  : { text:'-', alignment:'center', color:'#666', margin:[0,60,0,60] })
              ]
            },
            '' // celda vacía por rowSpan
          ]
        ]
      },
      layout: {
        hLineWidth: function(){ return 1; },
        vLineWidth: function(){ return 1; },
        hLineColor: function(){ return '#243045'; },
        vLineColor: function(){ return '#243045'; },
        paddingLeft: function(){ return 6; },
        paddingRight: function(){ return 6; },
        paddingTop: function(){ return 6; },
        paddingBottom: function(){ return 6; }
      }
    }

    ,
    {
      table: {
        widths: ['*','*','*'],
        body: [[
          { text: 'PLACA: ' + String(data.Placa||''), alignment:'center' },
          { text: 'FECHA: ' + String(data.Fecha||''), alignment:'center' },
          { text: 'FACTURA: ' + String(data.NumeroFactura||''), alignment:'center' }
        ]]
      },
      layout: {
        hLineWidth: function(){ return 1; },
        vLineWidth: function(){ return 1; },
        hLineColor: function(){ return '#243045'; },
        vLineColor: function(){ return '#243045'; },
        paddingLeft: function(){ return 6; },
        paddingRight: function(){ return 6; },
        paddingTop: function(){ return 6; },
        paddingBottom: function(){ return 6; }
      },
      margin:[0,8,-4,0]
    }

  ],
  pageBreak: 'after'
};
var page3={ stack:[ {text:'FACTURA ORIGINAL',style:'tSub',margin:[0,0,0,8],alignment:'center'}, (img['foto_factura']?{image:img['foto_factura'],fit:[510,680],alignment:'center'}:{text:'Sin imagen de factura',alignment:'center',color:'#666'}) ] };

      return { pageSize:'LETTER', pageMargins:[36,36,36,36], content:[page1,page2,page3], styles:{brand:{fontSize:18,bold:true},tTitulo:{fontSize:14,bold:true},mLbl:{bold:true},lbl:{bold:true},tCampos:{fontSize:10},tSub:{fontSize:12,bold:true},fotoLbl:{fontSize:9,italics:true,color:'#444'}}, defaultStyle:{fontSize:10} };
    }

    function renderPdfPreview(docDefinition){
      var iframe=$('previewFrame'); var fb=$('previewFallback'); var btnAbrir=$('btnAbrirPdf'); var linkDesc=$('linkDescargarPdf'); var jsContainer=$('pdfJsContainer');
      if (pdfEmbedPodriaFallar()) {
        window.pdfMake.createPdf(docDefinition).getBase64(function(b64){
          var hasPdfJs=!!(window.pdfjsLib && window.pdfjsLib.getDocument);
          if (hasPdfJs) {
            fb.hidden=true; iframe.style.display='none'; jsContainer.hidden=false; jsContainer.innerHTML='';
            if (window.pdfjsLib.GlobalWorkerOptions) {
              window.pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            }
            var data=base64ToUint8Array(b64);
            window.pdfjsLib.getDocument({data:data}).promise.then(async function(pdf){
              for(var p=1;p<=pdf.numPages;p++){
                var page=await pdf.getPage(p);
                var viewportCSS=page.getViewport({scale:1});
                var cssScale=(document.querySelector('.previewWrap').clientWidth-24)/viewportCSS.width;
                var outputScale=Math.min(window.devicePixelRatio||1,3);
                if(/HONOR|HUAWEI/i.test(navigator.userAgent||'')){ outputScale=Math.min((window.devicePixelRatio||1)*1.5,3); }
                var viewport=page.getViewport({scale:cssScale*outputScale});
                var canvas=document.createElement('canvas');
                var ctx=canvas.getContext('2d');
                canvas.width=Math.ceil(viewport.width);
                canvas.height=Math.ceil(viewport.height);
                var cssW=Math.round(viewport.width/outputScale);
                var cssH=Math.round(viewport.height/outputScale);
                canvas.style.width=cssW+'px';
                canvas.style.height=cssH+'px';
                canvas.className='pdfjs-page';
                await page.render({canvasContext:ctx,viewport:viewport}).promise;
                jsContainer.appendChild(canvas);
              }
            }).catch(function(){
              var dataUrl='data:application/pdf;base64,'+b64;
              fb.hidden=false; iframe.style.display='none'; jsContainer.hidden=true;
              btnAbrir.onclick=function(){ var w=window.open(dataUrl,'_blank','noopener'); if(!w) window.location.href=dataUrl; };
              linkDesc.href=dataUrl; linkDesc.download='reporte-preview.pdf';
            });
          } else {
            var dataUrl2='data:application/pdf;base64,'+b64;
            fb.hidden=false; iframe.style.display='none'; jsContainer.hidden=true;
            btnAbrir.onclick=function(){ var w2=window.open(dataUrl2,'_blank','noopener'); if(!w2) window.location.href=dataUrl2; };
            linkDesc.href=dataUrl2; linkDesc.download='reporte-preview.pdf';
          }
        });
        return;
      }
      window.pdfMake.createPdf(docDefinition).getBlob(function(blob){
        if (window.lastBlobUrl) { URL.revokeObjectURL(window.lastBlobUrl); window.lastBlobUrl=null; }
        var blobUrl=URL.createObjectURL(blob);
        window.lastBlobUrl=blobUrl;
        fb.hidden=true; jsContainer.hidden=true; iframe.style.display='block';
        iframe.src=blobUrl;
      });
    }

    var _previewTimer; function schedulePreview(){ clearTimeout(_previewTimer); _previewTimer=setTimeout(function(){ try{ var data=getFormData(); var dd=buildDocDefinition(data,ImageState); renderPdfPreview(dd); }catch(e){} },250); }

    async function postJSONWithRetry(url,payload,retries,timeoutMs){
      retries = retries || 0; timeoutMs = timeoutMs || 15000;
      var controller = new AbortController();
      var t = setTimeout(function(){ controller.abort(); }, timeoutMs);
      try{
        var res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json','Cache-Control':'no-cache'}, body: JSON.stringify(payload), signal: controller.signal });
        clearTimeout(t);
        if(!res.ok){
          var txtErr = await res.text().catch(function(){ return ''; });
          throw new Error('HTTP '+res.status + (txtErr?(' - '+txtErr.slice(0,200)):'') );
        }
        var txt = await res.text();
        var json = null;
        try { json = JSON.parse(txt); } catch(_){ json = null; }
        if (payload && payload.validarDuplicado === true && !json) { throw new Error('Respuesta no JSON'); }
        if (json && json.status && json.status !== 'OK') { throw new Error(json.message || 'Respuesta lógica inválida'); }
        return json || { status:'OK', raw: txt };
      }catch(e){
        clearTimeout(t);
        var transient = (e.name==='AbortError') || (e instanceof TypeError);
        if(transient && retries>0) return postJSONWithRetry(url,payload,retries-1,timeoutMs);
        throw e;
      }
    }

    async function cargarCatalogos(){ const selSector=$('sector'); const selPlaca=$('placa'); if(selSector) selSector.disabled=true; if(selPlaca) selPlaca.disabled=true; try{ const res=await fetch(urlCatalogos,{method:'GET',mode:'cors'}); const json=await res.json(); if(Array.isArray(json)){ const setSect=new Set(); const placasPorSector={}; const jefePorSector={}; for(const row of json){ const placa=(row&&row.PLACA?String(row.PLACA).trim():''); const sector=(row&&row.Sector?String(row.Sector).trim():''); const jefe=(row&&row['Jefe inmediato']?String(row['Jefe inmediato']).trim():''); if(!placa||!sector) continue; setSect.add(sector); (placasPorSector[sector]=placasPorSector[sector]||[]).push(placa); if(jefe && !jefePorSector[sector]) jefePorSector[sector]=jefe; } Catalogos.sectores=Array.from(setSect).sort(); Catalogos.placasPorSector=placasPorSector; Catalogos.jefePorSector=jefePorSector; setSelectOptions(selSector,Catalogos.sectores,'Selecciona…'); if(selSector) selSector.disabled=false; } }catch(e){ console.error('Catálogos:',e); } }

    function setSelectOptions(sel,arr,placeholder){ if(!sel) return; var opts=['<option value="">'+(placeholder||'Selecciona…')+'</option>'].concat((arr||[]).map(function(v){return '<option>'+String(v)+'</option>'})); sel.innerHTML=opts.join(''); }
    function onSectorChange(){ const selSector=$('sector'), selPlaca=$('placa'), jefeInput=$('jefe'); const sector=selSector?selSector.value:''; const placas=(Catalogos.placasPorSector[sector]||[]).slice().sort(); setSelectOptions(selPlaca,placas,'Selecciona…'); if(selPlaca) selPlaca.disabled=placas.length===0; if(jefeInput) jefeInput.value=Catalogos.jefePorSector[sector]||''; }

    async function enviarReporte(){

      if(isSaving) return;
      if(!validateForm()){ showToast('Completa los campos requeridos'); return; }
      isSaving = true; setBusy(true);
      let data, dd, filename, dedupeKey;
      try{
        await waitForPdfMake();
        data = getFormData();
        dd   = buildDocDefinition(data, ImageState);
        dedupeKey = ((data.Placa||'').trim().toUpperCase() + '|' + (data.Fecha||'').trim() + '|' + (data.NumeroFactura||'').trim());
        filename = ((data.Sector||'sector') + '_' + (data.Fecha||'fecha') + '_' + (data.NumeroFactura||'factura') + '.pdf')
          .replace(/\s+/g, '_')
          .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
          .replace(/[^A-Za-z0-9._-]/g, '');

        // === GUARDAR PRIMERO ===
        await doSave(dd, data, filename, dedupeKey); // doSave ya muestra progreso

        // === Preparar descarga diferida por gesto ===
        // Store para el click del usuario
        window.__lastDD = dd;
        window.__lastFileName = filename;
        // Habilitar UI y mostrar modal "Se descargará el PDF"
        setBusy(false); isSaving = false; if (typeof updateEnviarEnabled==='function') updateEnviarEnabled();
        showPreDescargaModal();

        // Render preview por si el usuario quiere ver
        try { renderPdfPreview(dd); } catch(_){}

      } catch (e) {
        setBusy(false);
        isSaving = false;
        alert('Error al guardar el reporte. Inténtalo de nuevo.');
      }

}


    async function doSave(dd, data, filename, dedupeKey){
      showProgress('Guardando información...');
      const b64 = await new Promise(function(resolve, reject){
        try { pdfMake.createPdf(dd).getBase64(function(val){ resolve(val); }); }
        catch(err){ reject(err); }
      });
      var __timeoutMs = 30000;
      await postJSONWithRetry(
        urlGuardarReporte,
        {
          Sector: data.Sector,
          Placa: data.Placa,
          Proceso: data.Proceso,
          Nombre: data.Nombre,
          Identidad: data.Identidad,
          TotalGastado: data.TotalGastado,
          LitrosConsumidos: data.LitrosConsumidos,
          MotivoDelLlenado: data.MotivoDelLlenado,
          Fecha: data.Fecha,
          HorasDelViaje: data.HorasDelViaje,
          KmActual: data.KmActual,
          NombreComercio: data.NombreComercio,
          NumeroFactura: data.NumeroFactura,
          JefeInmediato: data.JefeInmediato,
          pdf: b64,
          filename: filename,
          dedupeKey: dedupeKey
        },
        0,
        __timeoutMs
      );
      hideProgress('Información enviada correctamente');
    }

    function attachImageInputs(){ ['foto_tablero_antes','foto_bomba','foto_despues','foto_bomba_llenado','foto_frontal','foto_factura'].forEach(function(id){ var el=$(id); if(el) el.addEventListener('change',function(){handleImageInput(id)},{passive:true}); }); }

    document.addEventListener('DOMContentLoaded',function(){ attachImageInputs(); ['sector','proceso','placa','nombre','identidad','fecha','horas','km','total','litros','motivo','factura','nombre_comercio','jefe'].forEach(function(id){ var el=$(id); if(el) el.addEventListener('change',schedulePreview); }); });
    window.addEventListener('load', async function(){ try{ await waitForPdfMake(); await cargarCatalogos(); $('btnPreview').disabled=false; $('btnEnviar').disabled=false; $('btnPreview').addEventListener('click',schedulePreview); $('btnEnviar').addEventListener('click',enviarReporte); $('sector')&&$('sector').addEventListener('change', onSectorChange); }catch(e){} });
    window.addEventListener('beforeunload',function(){ if(window.lastBlobUrl) URL.revokeObjectURL(window.lastBlobUrl); });

  })();
  </script>













<script>
document.addEventListener('DOMContentLoaded', function(){
  var f = document.getElementById('factura') || document.getElementById('NumeroFactura');
  if (!f) return;
  var digits = (f.value.match(/\d/g)||[]).length;
  if (digits === 0) {
    try { setFacturaStatus('mute',''); setDuplicadaState(false);} catch(e){}
    if (typeof updateEnviarEnabled === 'function') updateEnviarEnabled();
  } else if (digits < 16) {
    var faltan = Math.max(0, 16 - digits);
    var txt = (faltan === 1) ? 'Falta 1 de 16 dígitos' : ('Faltan ' + faltan + ' de 16 dígitos');
    try { setFacturaStatus('warn', txt); setDuplicadaState(false);} catch(e){}
    if (typeof updateEnviarEnabled === 'function') updateEnviarEnabled();
  }
});
</script>


<style>
  /* Modal base */
  .overlay-modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999}
  .modal-card{background:#fff;max-width:520px;width:92%;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.2);padding:18px 18px 14px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#0f172a}
  .modal-card h3{margin:0 0 8px;font-size:18px;font-weight:700}
  .modal-card p{margin:0 0 14px;color:#374151}
  .modal-actions{display:flex;gap:10px;justify-content:flex-end}
  .modal-btn{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:600}
  .btn-primary{background:#0ea5e9;color:#fff}
  .btn-secondary{background:#e5e7eb;color:#111827}

  /* Toast de "Descargando..." */
  #downloadingToast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#0f1525;border:1px solid #213154;color:#eaf0f8;padding:.85rem 1rem;border-radius:.75rem;box-shadow:0 10px 20px rgba(0,0,0,.35);display:none;z-index:50}
  .spinner-mini{display:inline-block;vertical-align:-2px;width:14px;height:14px;border:2px solid #93c5fd;border-top-color:#1d4ed8;border-radius:50%;margin-right:8px;animation:spin-mini 0.9s linear infinite}
  @keyframes spin-mini{to{transform:rotate(360deg)}}

.form-grid textarea{width:100%; min-height:3.25rem; padding:0.5rem; border:1px solid #cbd5e1; border-radius:0.5rem;}
</style>

<!-- Modal 1: Se descargará el PDF -->
<div id="preDescargaOverlay" class="overlay-modal" role="dialog" aria-modal="true" aria-labelledby="preDescTitle">
  <div class="modal-card">
    <h3 id="preDescTitle">Se descargará el PDF</h3>
    <p>Al presionar <strong>Aceptar</strong>, iniciaremos la descarga del PDF.</p>
    <div class="modal-actions">
      <button type="button" id="btnAceptarDescarga" class="modal-btn btn-primary">Aceptar</button>
    </div>
  </div>
</div>

<!-- Toast Descargando -->
<div id="downloadingToast"><span class="spinner-mini"></span>Descargando…</div>

</div>


<script>
(function(){
  // Mostrar/ocultar overlays
  function show(el){ if(el){ el.style.display='flex'; } }
  function hide(el){ if(el){ el.style.display='none'; } }

  // Helpers: modal pre-descarga
  window.showPreDescargaModal = function(){
    var ov=document.getElementById('preDescargaOverlay');
    show(ov);
    setTimeout(function(){ try{ document.getElementById('btnAceptarDescarga').focus(); }catch(_){} },0);
  };
  function hidePre(){ hide(document.getElementById('preDescargaOverlay')); }

  // Toast "Descargando…"
  function showDownloadingToast(){
    var t=document.getElementById('downloadingToast');
    if(!t) return;
    t.style.display='block';
    clearTimeout(showDownloadingToast._t);
    showDownloadingToast._t=setTimeout(function(){ t.style.display='none'; }, 2500);
  }

  // Botón Aceptar: descargar y refrescar al terminar el toast
  document.addEventListener('DOMContentLoaded', function(){
    var btnAceptar = document.getElementById('btnAceptarDescarga');
    if (btnAceptar){
      btnAceptar.addEventListener('click', function(){
        btnAceptar.disabled = true;
        hidePre();
        try { if (window.__lastDD && window.__lastFileName) { pdfMake.createPdf(window.__lastDD).download(window.__lastFileName); } } catch(e){ console.warn('Descarga PDF falló:', e); }
        showDownloadingToast();
        setTimeout(function(){
          try {
            var base = location.href.split('#')[0];
            var url  = base + (base.indexOf('?') > -1 ? '&' : '?') + '_=' + Date.now();
            location.replace(url);
          } catch(_) {}
        }, 2600);
      });
    }
  });
})();
</script>



<script>
(function(){
  function isFacturaCompletaLocal(){
    var f = document.getElementById('factura') || document.getElementById('NumeroFactura');
    return !!(f && /^\d{3}-\d{3}-\d{2}-\d{8}$/.test(f.value||''));
  }
  window.updateEnviarEnabled = function(){
    var btn = document.getElementById('btnEnviar');
    if(!btn) return;
    var isSaving = (typeof window.isSaving !== 'undefined') ? !!window.isSaving : false;
    var dup = !!window.__facturaDuplicada;
    var complete = (isFacturaCompletaLocal() && (typeof isIdentidadCompletaLocal==='function' ? isIdentidadCompletaLocal() : true));
    btn.disabled = isSaving || dup || !complete;
  };
  document.addEventListener('DOMContentLoaded', function(){
    if (typeof updateEnviarEnabled === 'function') updateEnviarEnabled();
  });
})();
</script>
<script>
// ===== Máscara para Número de Factura: EXACTA 000-000-00-00000000 (16 dígitos, 19 chars con guiones) =====
(function(){
  function onlyDigits(s){ return (s||'').replace(/\D+/g,''); }
  function formatFactura(digits){
    var d = (digits||'').slice(0,16);
    var g1 = d.slice(0,3), g2 = d.slice(3,6), g3 = d.slice(6,8), g4 = d.slice(8,16);
    var out = g1;
    if(g2) out += (out?'-':'') + g2;
    if(g3) out += (out?'-':'') + g3;
    if(g4) out += (out?'-':'') + g4;
    return out;
  }
  function caretFromDigitIndex(formatted, digitCount){
    var count = 0;
    for (var i=0;i<formatted.length;i++){
      if (/\d/.test(formatted[i])) count++;
      if (count >= digitCount) return i+1;
    }
    return formatted.length;
  }
  function applyMaskAndPreserveCaret(input){
    var start = input.selectionStart || 0;
    var digitsBefore = (input.value.slice(0,start).match(/\d/g)||[]).length;
    var formatted = formatFactura(onlyDigits(input.value));
    if (formatted !== input.value) input.value = formatted;
    var newPos = caretFromDigitIndex(formatted, digitsBefore);
    try { input.setSelectionRange(newPos, newPos); } catch(e){}
    return formatted;
  }
  function isFacturaCompleta(){
    var f = document.getElementById('factura') || document.getElementById('NumeroFactura');
    return !!(f && /^\d{3}-\d{3}-\d{2}-\d{8}$/.test(f.value||''));
  }
  function initFacturaMask(input){
    if(!input) return;
    input.setAttribute('inputmode','numeric');
    input.setAttribute('autocomplete','off');
    input.setAttribute('autocorrect','off');
    input.setAttribute('spellcheck','false');
    input.setAttribute('minlength','19');
    input.setAttribute('maxlength','19');
    input.setAttribute('pattern','\\d{3}-\\d{3}-\\d{2}-\\d{8}');
    if(!input.getAttribute('placeholder')) input.setAttribute('placeholder','000-000-00-00000000');

    if (input.value) applyMaskAndPreserveCaret(input);

    var deb = (typeof debounce === 'function' && typeof validarFacturaSoloNumero === 'function')
      ? debounce(validarFacturaSoloNumero, 350)
      : null;

    input.addEventListener('input', function(){
      applyMaskAndPreserveCaret(input);
      var digits = (input.value.match(/\d/g)||[]).length;
      var complete = digits === 16 && /^\d{3}-\d{3}-\d{2}-\d{8}$/.test(input.value);
      if (!complete){
        // Cancelar validaciones en vuelo y futuros disparos
        try { if (window.__facturaAbort) { window.__facturaAbort.abort(); } } catch(e){}
        try { window.__facturaReqId = (window.__facturaReqId||0) + 1; } catch(e){}
        if (window.__facturaDebTimer){ clearTimeout(window.__facturaDebTimer); window.__facturaDebTimer=null; }
        // Mensaje de ayuda
        var faltan = Math.max(0, 16 - digits);
        var txt = (faltan === 1) ? 'Falta 1 de 16 dígitos' : ('Faltan ' + faltan + ' de 16 dígitos');
        if (typeof setFacturaStatus === 'function') setFacturaStatus('warn', txt);
        if (typeof setDuplicadaState === 'function') setDuplicadaState(false);
        if (typeof updateEnviarEnabled === 'function') updateEnviarEnabled();
        return;
      }
      // Completo: Validando (debounce propio)
      if (typeof setFacturaStatus === 'function') setFacturaStatus('loading','Validando…');
      if (window.__facturaDebTimer) clearTimeout(window.__facturaDebTimer);
      window.__facturaDebTimer = setTimeout(function(){
        try { validarFacturaSoloNumero(); } catch(e){}
      }, 350);
    }, {passive:false});
  }

  document.addEventListener('DOMContentLoaded', function(){
    var f = document.getElementById('factura') || document.getElementById('NumeroFactura');
    initFacturaMask(f);
    if (typeof updateEnviarEnabled === 'function') updateEnviarEnabled();
  });
})();
</script>
<script>
// ===== Máscara para Identidad: EXACTA 0000-0000-00000 (13 dígitos, 15 chars con guiones) =====
(function(){
  function onlyDigits(s){ return (s||'').replace(/\D+/g,''); }
  function formatIdentidad(digits){
    var d = (digits||'').slice(0,13);
    var g1 = d.slice(0,4), g2 = d.slice(4,8), g3 = d.slice(8,13);
    var out = g1;
    if(g2) out += (out?'-':'') + g2;
    if(g3) out += (out?'-':'') + g3;
    return out;
  }
  function caretFromDigitIndexId(formatted, digitCount){
    var count = 0;
    for (var i=0;i<formatted.length;i++){
      if (/\d/.test(formatted[i])) count++;
      if (count >= digitCount) return i+1;
    }
    return formatted.length;
  }
  function applyIdMaskAndCaret(input){
    var start = input.selectionStart || 0;
    var digitsBefore = (input.value.slice(0,start).match(/\d/g)||[]).length;
    var formatted = formatIdentidad(onlyDigits(input.value));
    if (formatted !== input.value) input.value = formatted;
    var newPos = caretFromDigitIndexId(formatted, digitsBefore);
    try { input.setSelectionRange(newPos, newPos); } catch(e){}
    return formatted;
  }
  function isIdentidadCompletaLocal(){
    var el = document.getElementById('identidad');
    return !!(el && /^\d{4}-\d{4}-\d{5}$/.test(el.value||''));
  }
  function updateErrIdentidad(){
    var el = document.getElementById('identidad');
    var box = document.getElementById('err_identidad_lbl') || document.getElementById('err_identidad');
    if (!el || !box) return;
    var digits = (el.value.match(/\d/g)||[]).length;
    if (digits === 0){
      box.textContent = '';
      return;
    }
    if (digits < 13){
      var faltan = 13 - digits;
      box.textContent = (faltan === 1) ? 'Falta 1 de 13 dígitos' : ('Faltan ' + faltan + ' de 13 dígitos');
    } else {
      // Completo
      box.textContent = '';
    }
  }
  function initIdentidadMask(input){
    if(!input) return;
    input.setAttribute('inputmode','numeric');
    input.setAttribute('autocomplete','off');
    input.setAttribute('autocorrect','off');
    input.setAttribute('spellcheck','false');
    input.setAttribute('minlength','15');
    input.setAttribute('maxlength','15');
    input.setAttribute('pattern','\\d{4}-\\d{4}-\\d{5}');
    if(!input.getAttribute('placeholder')) input.setAttribute('placeholder','0000-0000-00000');

    if (input.value) applyIdMaskAndCaret(input);
    updateErrIdentidad();

    input.addEventListener('input', function(){
      applyIdMaskAndCaret(input);
      updateErrIdentidad();
      if (typeof updateEnviarEnabled === 'function') updateEnviarEnabled();
    }, {passive:false});

    input.addEventListener('blur', function(){
      applyIdMaskAndCaret(input);
      updateErrIdentidad();
    });
  }

  document.addEventListener('DOMContentLoaded', function(){
    var el = document.getElementById('identidad');
    initIdentidadMask(el);
    if (typeof updateEnviarEnabled === 'function') updateEnviarEnabled();
  });

  // Exponer helper para el botón Enviar
  window.isIdentidadCompletaLocal = isIdentidadCompletaLocal;
})();
</script>

<script>
// ===== Validación en vivo de Número de factura (solo por número). Bloquea "Enviar" si es duplicada. =====
function getValidacionEndpoint(){
  try { return (typeof urlGuardarReporte !== 'undefined' && urlGuardarReporte) ? urlGuardarReporte : '/api/guardar'; }
  catch(e){ return '/api/guardar'; }
}
function debounce(fn, wait){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }
function setFacturaStatus(kind, text){
  var el=document.getElementById('facturaStatus');
  if(!el) return;
  el.className='factura-status '+(kind||'mute');
  el.textContent = text || '';
}
async function postJSONTolerant(url, payload, opts){
  opts = opts || {}; var timeoutMs = opts.timeoutMs || 15000; var signal = opts.signal;
  var ctrl = new AbortController(); var timer = setTimeout(()=>ctrl.abort(), timeoutMs);
  var merged = ctrl.signal; try{ if(signal){ merged = AbortSignal.any([signal, ctrl.signal]); } }catch(_){}
  try{
    var res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json','Cache-Control':'no-cache'}, body: JSON.stringify(payload), signal: merged });
    clearTimeout(timer);
    if(!res.ok){
      var t = ''; try{ t = await res.text(); }catch(_){}
      throw new Error('HTTP '+res.status+(t?(' - '+t.slice(0,200)):''));
    }
    var txt = ''; try{ txt = await res.text(); }catch(_){}
    try { return txt ? JSON.parse(txt) : { status:'OK' }; }
    catch { return { status:'OK', raw: txt }; }
  }catch(e){ clearTimeout(timer); throw e; }
}

// Estado global de duplicado
var __facturaDuplicada = false;
function setDuplicadaState(isDup){
  __facturaDuplicada = !!isDup;
  // Deshabilita el botón de enviar si hay duplicado o si ya está guardando
  try {
    var btn = document.getElementById('btnEnviar');
    if(btn){
      var isSaving = (typeof window.isSaving !== 'undefined') ? !!window.isSaving : false;
      btn.disabled = !!(__facturaDuplicada || isSaving);
    }
  } catch(_){}
}

var __facturaAbort = null;
async function validarFacturaSoloNumero(){
  // Solo validar con 16 dígitos exactos
  var fld = document.getElementById('factura') || document.getElementById('NumeroFactura');
  if (fld){
    var raw = (fld.value||'').replace(/\D+/g,'');
    if (raw.length !== 16){
      var faltan = Math.max(0, 16 - raw.length);
      var txt = (faltan === 1) ? 'Falta 1 de 16 dígitos' : ('Faltan ' + faltan + ' de 16 dígitos');
      try { setFacturaStatus('warn', txt); setDuplicadaState(false); } catch(e){}
      if (typeof updateEnviarEnabled === 'function') updateEnviarEnabled();
      return;
    }
  }

  // Gate: solo validar cuando hay exactamente 16 dígitos (formato 3-3-2-8)
  var fld = document.getElementById('factura') || document.getElementById('NumeroFactura');
  if (fld) {
    var raw = (fld.value||'').replace(/\D+/g,'');
    if (raw.length !== 16) {
      var faltan = Math.max(0, 16 - raw.length);
      var txt = (faltan === 1) ? 'Falta 1 de 16 dígitos' : ('Faltan ' + faltan + ' de 16 dígitos');
      try { setFacturaStatus('warn', txt); setDuplicadaState(false); } catch(e){}
      if (typeof updateEnviarEnabled === 'function') updateEnviarEnabled();
      return;
    }
  }

  var inp = document.getElementById('factura') || document.getElementById('NumeroFactura');
  if(!inp){ return; }
  var numero = (inp.value||'').trim();
  if(!numero){
    setFacturaStatus('mute','');
    setDuplicadaState(false);
    return;
  }
  setFacturaStatus('loading','Validando…');
  if(__facturaAbort){ try{ __facturaAbort.abort(); }catch(_){ } }
  __facturaAbort = new AbortController();
  try{
    var resp = await postJSONTolerant(getValidacionEndpoint(), {
      validarDuplicadoSoloFactura: true,
      NumeroFactura: numero
    }, { timeoutMs: 20000, signal: __facturaAbort.signal });
    var dup = !!(resp && resp.duplicado === true);
    if(dup){
      setFacturaStatus('err','Factura duplicada');
      setDuplicadaState(true);
    }else{
      setFacturaStatus('ok','Factura aceptada');
      setDuplicadaState(false);
    }
  }catch(e){
    // Si el error es por cancelación (AbortController), no cambiamos el estado: mantenemos "Validando…"
    var msg = (e && (e.name || e.message || e.toString())).toString();
    if (/AbortError|aborted/i.test(msg)) { return; }
    // Error real de red/servidor: mostramos aviso pero no bloqueamos
    setFacturaStatus('warn','No se pudo validar ahora');
    setDuplicadaState(false);
  }
}

// Hook de listeners
(function(){
  document.addEventListener('DOMContentLoaded', function(){
    var f = document.getElementById('factura') || document.getElementById('NumeroFactura');
    if(f){
      f.addEventListener('input', debounce(validarFacturaSoloNumero, 450));
      if(f.value){ validarFacturaSoloNumero(); }
    }
  });

  // Integración con el estado de guardado (si tu código usa window.isSaving)
  var _origDoSave = window.doSave;
  if(typeof _origDoSave === 'function'){
    window.doSave = async function(){ try{ window.isSaving = true; setDuplicadaState(__facturaDuplicada); return await _origDoSave.apply(this, arguments); } finally { window.isSaving = false; setDuplicadaState(__facturaDuplicada); } };
  }
})();
</script>



<script>
(function(){
  // === Helpers de número (US: decimal '.' y miles ',') ===
  function clampUS(str, maxDec){
    var s = String(str||'').trim();
    s = s.replace(/,/g,'').replace(/[^0-9.]/g,'');
    var first = s.indexOf('.');
    if (first !== -1){
      var intPart = s.slice(0, first).replace(/\./g,'');
      var fracPart = s.slice(first+1).replace(/\./g,'');
      if (maxDec >= 0) fracPart = fracPart.slice(0, maxDec);
      return intPart + '.' + fracPart;
    } else {
      return s.replace(/\./g,'');
    }
  }
  function toNumberUS(str){
    if (str == null) return NaN;
    var s = String(str);
    s = s.replace(/,/g,'');
    var n = parseFloat(s);
    return isNaN(n) ? NaN : n;
  }
  function formatPrettyUS(n, decimals){
    if (!isFinite(n)) return '';
    try {
      return n.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: decimals||0});
    } catch(_){
      return n.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: decimals||0});
    }
  }

  function bindMaxValidation(inputId, spanId, max, opts){
    opts = opts || {}; var decimals = (opts.decimals!=null?opts.decimals:2); var fixedOnBlur = !!opts.fixedOnBlur;
    var input = document.getElementById(inputId);
    if (!input) return;
    var span  = document.getElementById(spanId);
    var decimals = 2;

    if (span && !span.textContent) span.textContent = 'Máximo ' + max.toLocaleString('en-US');

    var onInput = function(forceFormat){
      var cleaned = clampUS(input.value, decimals);
      if (cleaned === '') {
        input.value = '';
        if (span) span.textContent = 'Máximo ' + max.toLocaleString('en-US');
        if (typeof window.updateEnviarEnabled === 'function') {
          if (inputId.toLowerCase().includes('litro')) window.__overMaxLitros = false;
          else window.__overMaxTotal = false;
          window.updateEnviarEnabled();
        }
        return;
      }
      var trailingSep = /\.$/.test(cleaned);
      var parts = cleaned.split('.');
      var fracLen = parts[1] ? parts[1].length : 0;

      var num = toNumberUS(cleaned);
      var ok = isFinite(num) && num <= max && num >= 0;

      if (!forceFormat && (trailingSep || fracLen > 0)){
        input.value = cleaned;
      } else {
        input.value = formatPrettyUS(num, decimals);
      }

      if (span) span.textContent = ok ? ('Máximo ' + max.toLocaleString('en-US'))
                                      : ('Excede el máximo ' + max.toLocaleString('en-US'));

      if (typeof window.updateEnviarEnabled === 'function') {
        window.__overMaxTotal  = window.__overMaxTotal  || false;
        window.__overMaxLitros = window.__overMaxLitros || false;
        if (inputId.toLowerCase().includes('litro')) window.__overMaxLitros = !ok;
        else window.__overMaxTotal = !ok;
        window.updateEnviarEnabled();
      } else {
        var btn = document.getElementById('btnEnviar') || document.querySelector('[type="submit"]');
        if (btn) btn.disabled = btn.disabled || !ok;
      }
    };

    var onBlur = function(){
      var cl = clampUS(input.value, decimals);
      if (cl === '') { onInput(true); return; }
      var num = toNumberUS(cl);
      if (isFinite(num)){
        if (fixedOnBlur){
          try { input.value = num.toLocaleString('en-US', {minimumFractionDigits: decimals, maximumFractionDigits: decimals}); }
          catch(_){ input.value = formatPrettyUS(num, decimals); }
        } else {
          input.value = formatPrettyUS(num, decimals);
        }
      }
      onInput(true);
    };

    input.setAttribute('inputmode','decimal');
    input.setAttribute('autocomplete','off');
    input.addEventListener('input', function(){ onInput(false); }, {passive:true});
    input.addEventListener('blur', onBlur);
    onInput(true);
  }

  document.addEventListener('DOMContentLoaded', function(){
    bindMaxValidation('total',  'err_total_lbl',  5000, {decimals:2, fixedOnBlur:true});
    bindMaxValidation('litros', 'err_litros_lbl', 250,  {decimals:2, fixedOnBlur:false});
  });

  (function(){
    var prev = window.updateEnviarEnabled;
    window.updateEnviarEnabled = function(){
      var btn = document.getElementById('btnEnviar') || document.querySelector('[type="submit"]');
      var dup = !!window.__facturaDuplicada;
      var complete = (typeof isFacturaCompletaLocal==='function' ? isFacturaCompletaLocal() : true)
                  && (typeof isIdentidadCompletaLocal==='function' ? isIdentidadCompletaLocal() : true);
      var overMax = !!window.__overMaxTotal || !!window.__overMaxLitros;
      var enabled = !dup && complete && !overMax;
      if (btn) btn.disabled = !enabled;
      if (typeof prev === 'function') try{ prev(); }catch(_){}
    };
  })();
})();
</script>



<script>
const LOGO_URL_UTCD="https://raw.githubusercontent.com/Sayox95/Gastos-de-Combustible/refs/heads/main/imagenes/Logo.png";
document.addEventListener('DOMContentLoaded', async () => {
  try{
    const res = await fetch(LOGO_URL_UTCD, {mode:'cors'});
    if(!res.ok) throw new Error(res.status);
    const blob = await res.blob();
    const fr = new FileReader();
    fr.onload = () => { window.__logoBase64 = fr.result; };
    fr.readAsDataURL(blob);
  }catch(e){ console.warn('No se pudo cargar el logo UTCD:', e); }
});
</script>






<script>
(function(){
  const ENDPOINT_PROCESOS = "https://script.google.com/macros/s/AKfycbw4KLB3AiRM6N1sC39cn1-HANO6ccsBQs3AeL6S5y-bt1IEoV8eZOakwHU_OSbspJWG/exec";
  const $ = (id) => document.getElementById(id);

  async function loadProcesos(){
    try{
      const res = await fetch(ENDPOINT_PROCESOS, { method:'GET', cache:'no-store' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      let data;
      try { data = await res.json(); }
      catch(_){ const txt = await res.text(); data = JSON.parse(txt); }

      // Esperado: { procesos: [...] } o bien un array plano
      const arr = Array.isArray(data?.procesos) ? data.procesos
                : (Array.isArray(data) ? data : []);

      // Acepta string o { proceso } o { Proceso }
      const norm = arr.map(it => {
                      if (typeof it === 'string') return it;
                      if (it && typeof it === 'object') return it.proceso ?? it.Proceso ?? '';
                      return '';
                    })
                    .filter(Boolean)
                    .sort((a,b)=>a.localeCompare(b,'es',{sensitivity:'base'}));

      const sel = $('proceso');
      if (!sel || sel.tagName !== 'SELECT') return;
      sel.innerHTML = '<option value="" disabled selected>Seleccione…</option>';
      for (const label of norm){
        const o = document.createElement('option');
        o.value = label;
        o.textContent = label;
        sel.appendChild(o);
      }
    }catch(err){
      console.warn('Error cargando procesos:', err);
      const sel = $('proceso');
      if (sel) sel.innerHTML = '<option value="" disabled selected>No disponible</option>';
    }
  }

  document.addEventListener('DOMContentLoaded', loadProcesos);
})();


function bindDualPicker(baseId){
  var input = document.getElementById(baseId);
  var cam   = document.getElementById('cam_' + baseId);
  var gal   = document.getElementById('gal_' + baseId);
  if(!input) return;
  if(cam){
    cam.addEventListener('click', function(){
      input.setAttribute('capture','environment');
      input.value = '';
      input.click();
    }, {passive:true});
  }
  if(gal){
    gal.addEventListener('click', function(){
      input.removeAttribute('capture');
      input.value = '';
      input.click();
    }, {passive:true});
  }
}
document.addEventListener('DOMContentLoaded', function(){
  ['foto_tablero_antes','foto_bomba','foto_despues','foto_bomba_llenado','foto_frontal','foto_factura']
    .forEach(function(id){ bindDualPicker(id); });
});

</script>





</body>
</html>
