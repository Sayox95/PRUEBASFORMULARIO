<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reporte de Gastos de Combustible</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
  <script defer src="https://unpkg.com/blueimp-load-image/js/load-image.all.min.js"></script>
  <style>
    :root{--space:clamp(.75rem,2.5vw,1rem);--space-lg:clamp(1rem,3.5vw,1.25rem);--radius:12px;--muted:#c9d3e0;--text:#eaf0f8;--primary:#4c9ffe;--danger:#ff5d7a}
    *{box-sizing:border-box}
    body{margin:0;font-family:Roboto,system-ui,-apple-system,Segoe UI,sans-serif;color:var(--text);background:#0b1020;padding:var(--space)}
    header{max-width:1024px;margin:0 auto var(--space-lg)}
    h1{font-size:clamp(1.25rem,3.5vw,1.75rem);margin:0 0 .25rem}
    p.sub{color:var(--muted);margin:0}
    .app{max-width:1024px;margin:0 auto;display:grid;gap:var(--space-lg)}
    .card{background:#0f172a;border:1px solid #2a3a5a;border-radius:var(--radius);padding:var(--space-lg)}
    .grid{display:grid;gap:var(--space)}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:900px){.grid.cols-3{grid-template-columns:1fr}}
    @media (max-width:700px){.grid.cols-2{grid-template-columns:1fr}}
    label{font-weight:600;display:block;margin-bottom:.35rem}
    input,select,textarea,button{width:100%;font-size:clamp(16px,2.6vw,18px);color:var(--text);background:#0f1525;border:1px solid #223052;border-radius:.75rem;padding:.85rem 1rem;outline:none}
    input::placeholder,textarea::placeholder{color:#8aa0bc}
    input:focus-visible,select:focus-visible,textarea:focus-visible,button:focus-visible{outline:3px solid var(--primary);outline-offset:2px}
    select{appearance:none;background-image:linear-gradient(45deg,transparent 50%,var(--muted) 50%),linear-gradient(135deg,var(--muted) 50%,transparent 50%);background-position:calc(100% - 20px) calc(1.1em),calc(100% - 15px) calc(1.1em);background-size:5px 5px,5px 5px;background-repeat:no-repeat}
    .actions{display:flex;gap:.75rem;flex-wrap:wrap}
    .btn{cursor:pointer;border-radius:999px;padding:.9rem 1.25rem;border:1px solid #2d3b5a;font-weight:600;background:#0b1222}
    .btn.primary{background:#225ad6;color:#eaf0f8;border-color:#1c4bb3}
    .btn.ok{background:#0fa86b;border-color:#118a59}
    .btn.danger{background:#ff476a;border-color:#e33e5d}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .error{color:var(--danger);font-size:.9rem;margin-top:.25rem;min-height:1.1em}
    .previewWrap{border-radius:var(--radius);overflow:clip;border:1px solid #213154}
    #previewFrame{width:100%;height:min(75vh,900px);display:block;border:0;background:#0a0f1e}
    #previewFallback{padding:var(--space)}
    #pdfJsContainer{background:#f4f5f7; padding:12px; display:block;}
    .pdfjs-page{display:block;margin:0 auto 12px;max-width:100%;height:auto;image-rendering:-webkit-optimize-contrast;image-rendering:crisp-edges;}
    .thumbs{display:grid;gap:var(--space);grid-template-columns:repeat(auto-fill,minmax(180px,1fr))}
    .thumb{border:1px dashed #335084;border-radius:.75rem;padding:.5rem;background:#0f172a;min-height:160px;display:grid;place-items:center}
    .thumb img{max-width:100%;height:auto;object-fit:contain;display:block}
    .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#0f2a1f;border:1px solid #1c7d57;color:#c8ffe7;padding:.85rem 1rem;border-radius:.75rem;box-shadow:0 10px 20px rgba(0,0,0,.35);display:none;z-index:50}
    @media print{@page{size:letter;margin:1.27cm}body{background:#fff;color:#000}.no-print{display:none !important}}
      .progressBarWrap{width:260px;height:8px;background:#1e2a44;border-radius:999px;overflow:hidden;border:1px solid #2a3a5a}
    .progressBar{height:100%;width:0%;background:#4c9ffe}
  </style>
</head>
<body>
  <header class="no-print">
    <h1>Reporte de Gastos de Combustible</h1>
    <p class="sub">Completa el formulario, previsualiza el PDF y envíalo. Compatible con móvil.</p>
  </header>
  <main class="app">
    <section class="card" aria-labelledby="formTitle">
      <h2 id="formTitle" style="margin-top:0">Formulario</h2>
      <form id="form" novalidate class="grid">
        <div class="grid cols-3">
          <div>
            <label for="sector">Sector</label>
            <select id="sector" name="sector" required disabled>
              <option value="">Cargando…</option>
            </select>
            <div class="error" id="err_sector"></div>
          </div>
          <div>
            <label for="proceso">Proceso</label>
            <input id="proceso" name="proceso" placeholder="Ej. Recolección" required />
            <div class="error" id="err_proceso"></div>
          </div>
          <div>
            <label for="placa">Placa</label>
            <select id="placa" name="placa" required disabled>
              <option value="">Selecciona…</option>
            </select>
            <div class="error" id="err_placa"></div>
          </div>
        </div>
        <div class="grid cols-3">
          <div>
            <label for="nombre">Nombre</label>
            <input id="nombre" name="nombre" placeholder="Nombre completo" required />
            <div class="error" id="err_nombre"></div>
          </div>
          <div>
            <label for="identidad">Identidad</label>
            <input id="identidad" name="identidad" placeholder="0000-0000-00000" required pattern="\d{4}-\d{4}-\d{5}" />
            <div class="error" id="err_identidad"></div>
          </div>
          <div>
            <label for="jefe">Jefe inmediato</label>
            <input id="jefe" name="jefe" placeholder="Nombre jefe" readonly />
            <div class="error" id="err_jefe"></div>
          </div>
        </div>
        <div class="grid cols-3">
          <div>
            <label for="fecha">Fecha</label>
            <input id="fecha" name="fecha" type="date" required />
            <div class="error" id="err_fecha"></div>
          </div>
          <div>
            <label for="horas">Horas del viaje</label>
            <input id="horas" name="horas" type="number" min="0" step="0.1" required />
            <div class="error" id="err_horas"></div>
          </div>
          <div>
            <label for="km">Km actual</label>
            <input id="km" name="km" type="number" min="0" step="1" required />
            <div class="error" id="err_km"></div>
          </div>
        </div>
        <div class="grid cols-3">
          <div>
            <label for="total">Total gastado (moneda)</label>
            <input id="total" name="total" type="number" min="0" step="0.01" required />
            <div class="error" id="err_total"></div>
          </div>
          <div>
            <label for="litros">Litros consumidos</label>
            <input id="litros" name="litros" type="number" min="0" step="0.01" required />
            <div class="error" id="err_litros"></div>
          </div>
          <div>
            <label for="motivo">Motivo del llenado</label>
            <input id="motivo" name="motivo" placeholder="Ej. Ruta diaria" required />
            <div class="error" id="err_motivo"></div>
          </div>
        </div>
        <div class="grid cols-3">
          <div>
            <label for="factura">Número de factura <span id="facturaStatus" class="factura-status" aria-live="polite"></span></label>
            <input id="factura" name="factura" required />
            <div class="error" id="err_factura"></div>
          </div>
          <div>
            <label for="nombre_comercio">Nombre del comercio</label>
            <input id="nombre_comercio" name="nombre_comercio" required />
            <div class="error" id="err_nombre_comercio"></div>
          </div>
          <div>
            <label for="sector_lista">Sector (lista opcional)</label>
            <select id="sector_lista" name="sector_lista">
              <option value="">Selecciona…</option>
              <option>Norte</option>
              <option>Sur</option>
              <option>Este</option>
              <option>Oeste</option>
            </select>
          </div>
        </div>
        <hr style="border-color:#223052;opacity:.5" />
        <div class="grid cols-3">
          <div>
            <label for="foto_tablero_antes">Foto tablero antes</label>
            <input id="foto_tablero_antes" type="file" accept="image/*" capture="environment" required />
            <div class="error" id="err_foto_tablero_antes"></div>
          </div>
          <div>
            <label for="foto_bomba">Foto bomba/contador</label>
            <input id="foto_bomba" type="file" accept="image/*" capture="environment" required />
            <div class="error" id="err_foto_bomba"></div>
          </div>
          <div>
            <label for="foto_despues">Foto tablero después</label>
            <input id="foto_despues" type="file" accept="image/*" capture="environment" required />
            <div class="error" id="err_foto_despues"></div>
          </div>
        </div>
        <div class="grid cols-3">
          <div>
            <label for="foto_bomba_llenado">Foto bomba llenado</label>
            <input id="foto_bomba_llenado" type="file" accept="image/*" capture="environment" required />
            <div class="error" id="err_foto_bomba_llenado"></div>
          </div>
          <div>
            <label for="foto_frontal">Foto frontal vehículo</label>
            <input id="foto_frontal" type="file" accept="image/*" capture="environment" required />
            <div class="error" id="err_foto_frontal"></div>
          </div>
          <div>
            <label for="foto_factura">Foto factura</label>
            <input id="foto_factura" type="file" accept="image/*" capture="environment" required />
            <div class="error" id="err_foto_factura"></div>
          </div>
        </div>
        <div class="thumbs">
          <div class="thumb" id="preview_foto_tablero_antes"><span>Preview tablero antes</span></div>
          <div class="thumb" id="preview_foto_bomba"><span>Preview bomba</span></div>
          <div class="thumb" id="preview_foto_despues"><span>Preview tablero después</span></div>
          <div class="thumb" id="preview_foto_bomba_llenado"><span>Preview bomba llenado</span></div>
          <div class="thumb" id="preview_foto_frontal"><span>Preview frontal</span></div>
          <div class="thumb" id="preview_foto_factura"><span>Preview factura</span></div>
        </div>
        <div class="actions">
          <button type="button" class="btn" id="btnPreview" disabled>Generar vista previa</button>
          <button type="button" class="btn primary" id="btnEnviar" disabled>Enviar y descargar PDF</button>
          <button type="reset" class="btn danger">Limpiar</button>
        </div>
      </form>
    </section>

    <section class="card no-print" aria-labelledby="prevTitle">
      <h2 id="prevTitle" style="margin-top:0">Vista previa del PDF</h2>
      <div class="previewWrap">
        <iframe id="previewFrame" title="Vista previa del PDF"></iframe>
        <div id="pdfJsContainer" hidden></div>
        <div id="previewFallback" hidden>
          <p>Tu navegador no puede mostrar el PDF embebido.</p>
          <div class="actions">
            <button id="btnAbrirPdf" class="btn">Abrir</button>
            <a id="linkDescargarPdf" class="btn ok" download>Descargar PDF</a>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite">Listo</div>

  <div id="progressToast" class="toast" style="display:none" hidden>
    <div id="progressLabel" style="margin-bottom:6px">Guardando información...</div>
    <div class="progressBarWrap"><div id="progressBar" class="progressBar" style="width:0%"></div></div>
  </div>
  <script>
  (function(){
    'use strict';

    const ImageState = {};
    let isSaving = false;
    const urlGuardarReporte = '/api/guardar';
    const Catalogos = { sectores: [], placasPorSector: {}, jefePorSector: {} };
    const urlCatalogos = 'https://script.google.com/macros/s/AKfycbxp2yVp4hF-t9f2LdU9NhZxVt6RwXyL3uKrKzXk4a_l4na2Rkd1LZMB02pEJeRQ_eCF/exec';

    function $(id){ return document.getElementById(id); }
    function showToast(msg){ const t=$('toast'); if(!t) return; t.textContent=msg||'Hecho'; t.style.display='block'; clearTimeout(showToast._t); showToast._t=setTimeout(()=>{ t.style.display='none'; }, 2500); }
    function setBusy(b){ document.querySelectorAll('button').forEach(x=>x.disabled=!!b); }

    function showError(input,text){ const e=$('err_'+input.id); if(e) e.textContent=text||''; }
    function trimUpper(v){ return (v||'').trim().toUpperCase(); }
    function trimAny(v){ return (v||'').trim(); }

    function pdfEmbedPodriaFallar(){
      const ua=navigator.userAgent||navigator.vendor||'';
      const iOS=/iPad|iPhone|iPod/i.test(ua);
      const isSafari=/^((?!chrome|android).)*safari/i.test(ua);
      const isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);
      return (iOS && isSafari) || isMobile;
    }

    function showProgress(label){ const t=$('progressToast'),l=$('progressLabel'); if(!t||!l) return; l.textContent=label||'Guardando información...'; t.hidden=false; t.style.display='block'; setProgress(10); clearInterval(showProgress._timer); showProgress._timer=setInterval(()=>{ const b=$('progressBar'); const curr=parseInt(b&&b.style && b.style.width ? b.style.width : '0')||0; if(curr<85) setProgress(curr+5); },400); }
    function setProgress(p){ const b=$('progressBar'); if(b){ const v=Math.max(0,Math.min(100,Number(p)||0)); b.style.width=v+'%'; } }
    function hideProgress(msg){ const t=$('progressToast'),b=$('progressBar'); clearInterval(showProgress._timer); setProgress(100); setTimeout(()=>{ if(t){ t.style.display='none'; t.hidden=true; } if(b) b.style.width='0%'; if(msg) showToast(msg); },300); }

    function readFileAsDataURL(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=()=>rej(fr.error||new Error('FileReader')); fr.readAsDataURL(file); }); }
    function drawToCanvas(imgLike,maxW,maxH){ const iw=imgLike.naturalWidth||imgLike.width; const ih=imgLike.naturalHeight||imgLike.height; const r=Math.min(maxW/iw,maxH/ih,1); const tw=Math.max(1,Math.round(iw*r)); const th=Math.max(1,Math.round(ih*r)); const c=document.createElement('canvas'); c.width=tw; c.height=th; const ctx=c.getContext('2d'); ctx.drawImage(imgLike,0,0,tw,th); return c; }
    const SUPPORTED_IMAGE_TYPES=new Set(['image/jpeg','image/png','image/webp']);
    async function fileToOptimizedBase64(file,maxW=1600,maxH=1600,quality=0.7){ if(!file) throw new Error('Archivo inválido'); if(!SUPPORTED_IMAGE_TYPES.has(file.type)){ const e=new Error('Formato no soportado'); e.code='UNSUPPORTED_FORMAT'; e.type=file.type||'unknown'; throw e; } const dataUrl=await readFileAsDataURL(file); const img=await new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=dataUrl; }); const canvas=drawToCanvas(img,maxW,maxH); return canvas.toDataURL('image/jpeg',quality); }

    async function handleImageInput(inputId){ const input=$(inputId); const file=input&&input.files&&input.files[0]; if(!file){ ImageState[inputId]=null; return; } const isRecent=(Date.now()-file.lastModified)<=48*3600*1000; if(!isRecent){ showError(input,'La foto debe ser ≤ 48 horas'); input.value=''; return; } try{ const optimized=await fileToOptimizedBase64(file,1600,1600,0.7); ImageState[inputId]=optimized; requestAnimationFrame(()=>{ const prev=$('preview_'+inputId); if(prev) prev.innerHTML='<img alt="" src="'+optimized+'">'; }); }catch(err){ if(err&&err.code==='UNSUPPORTED_FORMAT') showError(input,'Formato no soportado ('+(err.type||'')+'). Usa JPG/PNG/WebP.'); else showError(input,'No se pudo leer la imagen'); } }

    function validateForm(){ let ok=true; document.querySelectorAll('#form [required]').forEach(inp=>{ if(!inp.checkValidity()){ ok=false; showError(inp, inp.validationMessage); } else { showError(inp,''); } }); const ids=['foto_tablero_antes','foto_bomba','foto_despues','foto_bomba_llenado','foto_frontal','foto_factura']; for(const id of ids){ const el=$(id); if(!el.files||!el.files[0]){ ok=false; showError(el,'Requerido'); continue; } const f=el.files[0]; const recent=(Date.now()-f.lastModified)<=48*3600*1000; if(!recent){ ok=false; showError(el,'La foto debe ser ≤ 48 horas'); } } return ok; }

    function getFormData(){ return { Sector: trimAny($('sector').value||$('sector_lista').value), Placa: trimUpper($('placa').value), Proceso: trimAny($('proceso').value), Nombre: trimAny($('nombre').value), Identidad: trimAny($('identidad').value), TotalGastado: trimAny($('total').value), LitrosConsumidos: trimAny($('litros').value), MotivoDelLlenado: trimAny($('motivo').value), Fecha: trimAny($('fecha').value), HorasDelViaje: trimAny($('horas').value), KmActual: trimAny($('km').value), NumeroFactura: trimAny($('factura').value), NombreComercio: trimAny($('nombre_comercio').value), JefeInmediato: trimAny(($('jefe').value)||'') }; }

    function waitForPdfMake(timeout){ timeout=timeout||12000; return new Promise(function(resolve,reject){ var t0=Date.now(); (function check(){ if(window.pdfMake && typeof window.pdfMake.createPdf==='function') return resolve(window.pdfMake); if(Date.now()-t0>timeout) return reject(new Error('pdfMake no cargó')); setTimeout(check,30); })(); }); }

    function base64ToUint8Array(base64){ var bin=atob(base64); var len=bin.length; var bytes=new Uint8Array(len); for(var i=0;i<len;i++) bytes[i]=bin.charCodeAt(i); return bytes; }

    function buildDocDefinition(data,img){
      var hasLogo=!!img.logo;
      var header={ columns:[ {width:120,alignment:'left',margin:[0,0,10,0],stack:[hasLogo?{image:img.logo,width:110}:{text:'UTCD',style:'brand'}]}, {width:'*',alignment:'center',stack:[{text:'DETALLE DE LA FACTURA DE COMBUSTIBLE',style:'tTitulo'}]}, {width:160,table:{widths:['*','*'],body:[[{text:'Código',style:'mLbl',alignment:'center'},{text:'CLS-PAU-F-19',alignment:'center'}],[{text:'Versión',style:'mLbl',alignment:'center'},{text:'1',alignment:'center'}],[{text:'Fecha',style:'mLbl',alignment:'center'},{text:'20/5/2025',alignment:'center'}]]},layout:{paddingLeft:function(){return 4},paddingRight:function(){return 4},paddingTop:function(){return 3},paddingBottom:function(){return 3}} } ], columnGap:10, margin:[0,0,0,6] };

      var infoTable={ style:'tCampos', table:{ widths:[100,165], heights:function(row){ return row===5?110:(row===2||row===10?48:38); }, body:[ [{text:'Nombre Completo',style:'lbl'},data.Nombre||'' ], [{text:'No. Identidad',style:'lbl'},data.Identidad||'' ], [{text:'Firma del Colaborador',style:'lbl'},{text:'', margin:[0,10,0,6]}], [{text:'Tipo de Gestión',style:'lbl'},'Liquidación de gastos de combustible' ], [{text:'Total',style:'lbl'},(data.LitrosConsumidos?(String(data.LitrosConsumidos)+' L'):'') ], [{text:'Motivo del llenado de combustible',style:'lbl'}, { stack: [ {text:'Compra de Combustible al Vehículo', margin:[0,0,0,4]}, {text:['Para Labores de: ',{text:(data.ParaLabores||'')}], margin:[0,4,0,0]}, {text:(data.MotivoDelLlenado||''), margin:[0,4,0,0]}, {text:['Proceso: ',{text:(data.Proceso||'')}], margin:[0,4,0,0]} ] } ], [{text:'Fecha',style:'lbl'},data.Fecha||'' ], [{text:'Placa o VIN',style:'lbl'},data.Placa||'' ], [{text:'Observación',style:'lbl'},{stack:[{text:'SECTOR: '+(data.Sector||'')},{text:'KM: '+(data.KmActual||'')},{text:'FACTURA: '+(data.NumeroFactura||'')}]}], [{text:'Autorizado por Jefe Inmediato',style:'lbl'},(data.JefeInmediato||'') ], [{text:'Firma',style:'lbl'},{text:'', margin:[0,10,0,6]}] ] }, layout:{hLineWidth:function(){return 1},vLineWidth:function(){return 1},hLineColor:'#000',vLineColor:'#000',paddingLeft:function(){return 4},paddingRight:function(){return 4},paddingTop:function(){return 3},paddingBottom:function(){return 3}} };

      var cuadroFacturaGuia={ table:{widths:[230],body:[[{text:'Pegar Factura Original en este Espacio',alignment:'center',italics:true,color:'#666'}]]}, layout:{hLineWidth:function(){return 1},vLineWidth:function(){return 1},hLineColor:'#000',vLineColor:'#000',paddingLeft:function(){return 6},paddingRight:function(){return 6},paddingTop:function(){return 300},paddingBottom:function(){return 300}}, margin:[0,6,10,0] };

      var page1={ stack:[ header, { columns:[ {width:230,stack:[cuadroFacturaGuia]}, {width:'*',stack:[infoTable],margin:[0,6,12,0]} ], columnGap:26 } ], pageBreak:'after' };

      function fotoCard(titulo,phKey){ return { stack:[ {text:titulo,style:'fotoLbl',alignment:'center',margin:[0,0,0,4]}, (img[phKey]?{image:img[phKey],width:170,alignment:'center'}:{text:'-',color:'#666',alignment:'center',margin:[0,30,0,30]}) ] }; }

      var page2={ stack:[ {text:'FOTOGRAFÍAS',style:'tSub',margin:[0,0,0,8],alignment:'center'}, {columns:[ fotoCard('TABLERO ANTES DE LLENADO','foto_tablero_antes'), fotoCard('BOMBA DE COMBUSTIBLE','foto_bomba'), fotoCard('TABLERO DESPUÉS DE LLENADO','foto_despues') ],columnGap:12,margin:[0,4,0,16]}, {columns:[ fotoCard('BOMBA DE COMBUSTIBLE LLENA','foto_bomba_llenado'), fotoCard('VISTA FRONTAL DEL VEHÍCULO / VIN CON VEHICULO','foto_frontal'), fotoCard('FACTURA','foto_factura') ],columnGap:12} ], pageBreak:'after' };

      var page3={ stack:[ {text:'FACTURA ORIGINAL',style:'tSub',margin:[0,0,0,8],alignment:'center'}, (img['foto_factura']?{image:img['foto_factura'],fit:[510,680],alignment:'center'}:{text:'Sin imagen de factura',alignment:'center',color:'#666'}) ] };

      return { pageSize:'LETTER', pageMargins:[36,36,36,36], content:[page1,page2,page3], styles:{brand:{fontSize:18,bold:true},tTitulo:{fontSize:14,bold:true},mLbl:{bold:true},lbl:{bold:true},tCampos:{fontSize:10},tSub:{fontSize:12,bold:true},fotoLbl:{fontSize:9,italics:true,color:'#444'}}, defaultStyle:{fontSize:10} };
    }

    function renderPdfPreview(docDefinition){
      var iframe=$('previewFrame'); var fb=$('previewFallback'); var btnAbrir=$('btnAbrirPdf'); var linkDesc=$('linkDescargarPdf'); var jsContainer=$('pdfJsContainer');
      if (pdfEmbedPodriaFallar()) {
        window.pdfMake.createPdf(docDefinition).getBase64(function(b64){
          var hasPdfJs=!!(window.pdfjsLib && window.pdfjsLib.getDocument);
          if (hasPdfJs) {
            fb.hidden=true; iframe.style.display='none'; jsContainer.hidden=false; jsContainer.innerHTML='';
            if (window.pdfjsLib.GlobalWorkerOptions) {
              window.pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            }
            var data=base64ToUint8Array(b64);
            window.pdfjsLib.getDocument({data:data}).promise.then(async function(pdf){
              for(var p=1;p<=pdf.numPages;p++){
                var page=await pdf.getPage(p);
                var viewportCSS=page.getViewport({scale:1});
                var cssScale=(document.querySelector('.previewWrap').clientWidth-24)/viewportCSS.width;
                var outputScale=Math.min(window.devicePixelRatio||1,3);
                if(/HONOR|HUAWEI/i.test(navigator.userAgent||'')){ outputScale=Math.min((window.devicePixelRatio||1)*1.5,3); }
                var viewport=page.getViewport({scale:cssScale*outputScale});
                var canvas=document.createElement('canvas');
                var ctx=canvas.getContext('2d');
                canvas.width=Math.ceil(viewport.width);
                canvas.height=Math.ceil(viewport.height);
                var cssW=Math.round(viewport.width/outputScale);
                var cssH=Math.round(viewport.height/outputScale);
                canvas.style.width=cssW+'px';
                canvas.style.height=cssH+'px';
                canvas.className='pdfjs-page';
                await page.render({canvasContext:ctx,viewport:viewport}).promise;
                jsContainer.appendChild(canvas);
              }
            }).catch(function(){
              var dataUrl='data:application/pdf;base64,'+b64;
              fb.hidden=false; iframe.style.display='none'; jsContainer.hidden=true;
              btnAbrir.onclick=function(){ var w=window.open(dataUrl,'_blank','noopener'); if(!w) window.location.href=dataUrl; };
              linkDesc.href=dataUrl; linkDesc.download='reporte-preview.pdf';
            });
          } else {
            var dataUrl2='data:application/pdf;base64,'+b64;
            fb.hidden=false; iframe.style.display='none'; jsContainer.hidden=true;
            btnAbrir.onclick=function(){ var w2=window.open(dataUrl2,'_blank','noopener'); if(!w2) window.location.href=dataUrl2; };
            linkDesc.href=dataUrl2; linkDesc.download='reporte-preview.pdf';
          }
        });
        return;
      }
      window.pdfMake.createPdf(docDefinition).getBlob(function(blob){
        if (window.lastBlobUrl) { URL.revokeObjectURL(window.lastBlobUrl); window.lastBlobUrl=null; }
        var blobUrl=URL.createObjectURL(blob);
        window.lastBlobUrl=blobUrl;
        fb.hidden=true; jsContainer.hidden=true; iframe.style.display='block';
        iframe.src=blobUrl;
      });
    }

    var _previewTimer; function schedulePreview(){ clearTimeout(_previewTimer); _previewTimer=setTimeout(function(){ try{ var data=getFormData(); var dd=buildDocDefinition(data,ImageState); renderPdfPreview(dd); }catch(e){} },250); }

    async function postJSONWithRetry(url,payload,retries,timeoutMs){
      retries = retries || 0; timeoutMs = timeoutMs || 15000;
      var controller = new AbortController();
      var t = setTimeout(function(){ controller.abort(); }, timeoutMs);
      try{
        var res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json','Cache-Control':'no-cache'}, body: JSON.stringify(payload), signal: controller.signal });
        clearTimeout(t);
        if(!res.ok){
          var txtErr = await res.text().catch(function(){ return ''; });
          throw new Error('HTTP '+res.status + (txtErr?(' - '+txtErr.slice(0,200)):'') );
        }
        var txt = await res.text();
        var json = null;
        try { json = JSON.parse(txt); } catch(_){ json = null; }
        if (payload && payload.validarDuplicado === true && !json) { throw new Error('Respuesta no JSON'); }
        if (json && json.status && json.status !== 'OK') { throw new Error(json.message || 'Respuesta lógica inválida'); }
        return json || { status:'OK', raw: txt };
      }catch(e){
        clearTimeout(t);
        var transient = (e.name==='AbortError') || (e instanceof TypeError);
        if(transient && retries>0) return postJSONWithRetry(url,payload,retries-1,timeoutMs);
        throw e;
      }
    }

    async function cargarCatalogos(){ const selSector=$('sector'); const selPlaca=$('placa'); if(selSector) selSector.disabled=true; if(selPlaca) selPlaca.disabled=true; try{ const res=await fetch(urlCatalogos,{method:'GET',mode:'cors'}); const json=await res.json(); if(Array.isArray(json)){ const setSect=new Set(); const placasPorSector={}; const jefePorSector={}; for(const row of json){ const placa=(row&&row.PLACA?String(row.PLACA).trim():''); const sector=(row&&row.Sector?String(row.Sector).trim():''); const jefe=(row&&row['Jefe inmediato']?String(row['Jefe inmediato']).trim():''); if(!placa||!sector) continue; setSect.add(sector); (placasPorSector[sector]=placasPorSector[sector]||[]).push(placa); if(jefe && !jefePorSector[sector]) jefePorSector[sector]=jefe; } Catalogos.sectores=Array.from(setSect).sort(); Catalogos.placasPorSector=placasPorSector; Catalogos.jefePorSector=jefePorSector; setSelectOptions(selSector,Catalogos.sectores,'Selecciona…'); if(selSector) selSector.disabled=false; } }catch(e){ console.error('Catálogos:',e); } }

    function setSelectOptions(sel,arr,placeholder){ if(!sel) return; var opts=['<option value="">'+(placeholder||'Selecciona…')+'</option>'].concat((arr||[]).map(function(v){return '<option>'+String(v)+'</option>'})); sel.innerHTML=opts.join(''); }
    function onSectorChange(){ const selSector=$('sector'), selPlaca=$('placa'), jefeInput=$('jefe'); const sector=selSector?selSector.value:''; const placas=(Catalogos.placasPorSector[sector]||[]).slice().sort(); setSelectOptions(selPlaca,placas,'Selecciona…'); if(selPlaca) selPlaca.disabled=placas.length===0; if(jefeInput) jefeInput.value=Catalogos.jefePorSector[sector]||''; }

    async function enviarReporte(){
      if(isSaving) return;
      if(!validateForm()){ showToast('Completa los campos requeridos'); return; }
      isSaving = true; setBusy(true);
      let data, dd, filename, dedupeKey;
      try{
        await waitForPdfMake();
        data = getFormData();
        dd   = buildDocDefinition(data, ImageState);
        dedupeKey = ((data.Placa||'').trim().toUpperCase() + '|' + (data.Fecha||'').trim() + '|' + (data.NumeroFactura||'').trim());
        filename = ((data.Sector||'sector') + '_' + (data.Fecha||'fecha') + '_' + (data.NumeroFactura||'factura') + '.pdf')
          .replace(/\s+/g, '_')
          .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
          .replace(/[^A-Za-z0-9._-]/g, '');

        try { pdfMake.createPdf(dd).download(filename); } catch (e) {}

        setTimeout(async function(){
          try {
            await doSave(dd, data, filename, dedupeKey);
          } catch (e) {
            try {
              const ver = await postJSONWithRetry(
                urlGuardarReporte,
                { validarDuplicado: true, Placa: data.Placa, Fecha: data.Fecha, NumeroFactura: data.NumeroFactura },
                0,
                12000
              );
              if (ver && ver.duplicado === true) {
                showToast('Envío confirmado en servidor');
              } else {
                alert('Error al guardar el reporte. Inténtalo de nuevo.');
              }
            } catch (e2) {
              alert('Error al guardar el reporte. Inténtalo de nuevo.');
            }
          } finally {
            setBusy(false);
            isSaving = false;
          }
        }, 0);

        renderPdfPreview(dd);
      } catch (e) {
        setBusy(false);
        isSaving = false;
        alert('No se pudo generar el PDF');
      }
    }

    async function doSave(dd, data, filename, dedupeKey){
      showProgress('Guardando información...');
      const b64 = await new Promise(function(resolve, reject){
        try { pdfMake.createPdf(dd).getBase64(function(val){ resolve(val); }); }
        catch(err){ reject(err); }
      });
      await postJSONWithRetry(
        urlGuardarReporte,
        {
          Sector: data.Sector,
          Placa: data.Placa,
          Proceso: data.Proceso,
          Nombre: data.Nombre,
          Identidad: data.Identidad,
          TotalGastado: data.TotalGastado,
          LitrosConsumidos: data.LitrosConsumidos,
          MotivoDelLlenado: data.MotivoDelLlenado,
          Fecha: data.Fecha,
          HorasDelViaje: data.HorasDelViaje,
          KmActual: data.KmActual,
          NombreComercio: data.NombreComercio,
          NumeroFactura: data.NumeroFactura,
          JefeInmediato: data.JefeInmediato,
          pdf: b64,
          filename: filename,
          dedupeKey: dedupeKey
        },
        0,
        20000
      );
      hideProgress('Información enviada correctamente');
    }

    function attachImageInputs(){ ['foto_tablero_antes','foto_bomba','foto_despues','foto_bomba_llenado','foto_frontal','foto_factura'].forEach(function(id){ var el=$(id); if(el) el.addEventListener('change',function(){handleImageInput(id)},{passive:true}); }); }

    document.addEventListener('DOMContentLoaded',function(){ attachImageInputs(); ['sector','sector_lista','proceso','placa','nombre','identidad','fecha','horas','km','total','litros','motivo','factura','nombre_comercio','jefe'].forEach(function(id){ var el=$(id); if(el) el.addEventListener('change',schedulePreview); }); });
    window.addEventListener('load', async function(){ try{ await waitForPdfMake(); await cargarCatalogos(); $('btnPreview').disabled=false; $('btnEnviar').disabled=false; $('btnPreview').addEventListener('click',schedulePreview); $('btnEnviar').addEventListener('click',enviarReporte); $('sector')&&$('sector').addEventListener('change', onSectorChange); }catch(e){} });
    window.addEventListener('beforeunload',function(){ if(window.lastBlobUrl) URL.revokeObjectURL(window.lastBlobUrl); });

  })();
  </script>

<style>
.factura-status {
  display: inline-flex;
  align-items: center;
  gap: .5rem;
  margin-left: .75rem;
  font-size: .9rem;
  font-weight: 600;
}
.factura-status.ok    { color: #0b8a3a; }
.factura-status.warn  { color: #b26a00; }
.factura-status.err   { color: #b00020; }
.factura-status.mute  { color: #6b7280; }
.factura-status .spin {
  width: 14px;
  height: 14px;
  border: 2px solid currentColor;
  border-right-color: transparent;
  border-radius: 50%;
  display: inline-block;
  animation: giro .8s linear infinite;
  transform: translateY(1px);
}
@keyframes giro { to { transform: rotate(360deg) translateY(1px); } }
</style>

<script>
const VALIDACION_ENDPOINT = (typeof urlGuardarReporte !== 'undefined' && urlGuardarReporte)
  ? urlGuardarReporte
  : '/api/guardar';

function debounce(fn, wait){
  let t; return function(...args){
    clearTimeout(t); t = setTimeout(()=>fn.apply(this,args), wait);
  };
}

function setFacturaStatus(kind, text, withSpinner=false){
  const el = document.getElementById('facturaStatus');
  if(!el) return;
  el.className = 'factura-status ' + (kind || 'mute');
  el.innerHTML = (withSpinner ? '<span class="spin" aria-hidden="true"></span>' : '') +
                 '<span>' + (text || '') + '</span>';
}

async function postJSONTolerant(url, payload, {timeoutMs=12000, signal}={}){
  const ctrl = new AbortController();
  const timer = setTimeout(()=>ctrl.abort(), timeoutMs);
  let mergedSignal = ctrl.signal;
  if (signal) {
    try { mergedSignal = AbortSignal.any([signal, ctrl.signal]); } catch(e) { mergedSignal = ctrl.signal; }
  }
  try{
    const res = await fetch(url, {
      method: 'POST',
      headers: {'Content-Type':'application/json','Cache-Control':'no-cache'},
      body: JSON.stringify(payload),
      signal: mergedSignal
    });
    clearTimeout(timer);
    if(!res.ok) {
      const txt = await res.text().catch(()=> '');
      throw new Error('HTTP '+res.status+(txt?(' - '+txt.slice(0,200)):''));
    }
    const txt = await res.text();
    try { return txt ? JSON.parse(txt) : { status:'OK' }; }
    catch { return { status: 'OK', raw: txt }; }
  } catch(e){
    clearTimeout(timer);
    throw e;
  }
}

let facturaCtrl = null;

async function validarNumeroFactura(numero){
  const val = (numero || '').trim();
  if(!val){
    setFacturaStatus('mute','');
    return;
  }
  setFacturaStatus('mute','Validando…', true);
  if (facturaCtrl) facturaCtrl.abort();
  facturaCtrl = new AbortController();
  try{
    const resp = await postJSONTolerant(
      VALIDACION_ENDPOINT,
      { validarDuplicado: true, NumeroFactura: val },
      { timeoutMs: 15000, signal: facturaCtrl.signal }
    );
    let isDup = false;
    if (resp && typeof resp === 'object') {
      if ('duplicado' in resp) isDup = !!resp.duplicado;
      else if (Array.isArray(resp) && resp.length > 0) isDup = true;
      else if (resp.status === 'DUPLICADO') isDup = true;
    }
    if (isDup) {
      setFacturaStatus('err','Factura duplicada');
    } else {
      setFacturaStatus('ok','Factura aceptada');
    }
  } catch(e){
    setFacturaStatus('warn','No se pudo validar ahora');
  }
}

function setupValidacionFactura(){
  const input = document.getElementById('NumeroFactura');
  if(!input) return;
  const onType = debounce(()=> validarNumeroFactura(input.value), 450);
  input.addEventListener('input', onType);
  if (input.value) validarNumeroFactura(input.value);
}

document.addEventListener('DOMContentLoaded', setupValidacionFactura);
</script>


<script>
// --- PATCH: asegurar ancla visual para estado de factura ---
function ensureFacturaStatusAnchor(){
  var span = document.getElementById('facturaStatus');
  if (span) return span;
  var input = document.getElementById('NumeroFactura');
  if (!input) return null;

  // 1) Intentar junto al label asociado
  var label = document.querySelector('label[for="NumeroFactura"]');
  span = document.createElement('span');
  span.id = 'facturaStatus';
  span.className = 'factura-status';
  span.setAttribute('aria-live', 'polite');

  try {
    if (label) {
      label.appendChild(span);
      return span;
    }
  } catch(e){}

  // 2) Si no hay label: intentar antes del input (a la par del título) o justo después
  try {
    input.insertAdjacentElement('beforebegin', span);
    return span;
  } catch(e){
    try {
      input.insertAdjacentElement('afterend', span);
      return span;
    } catch(e2){}
  }
  return null;
}

// Sobrescribir setFacturaStatus para asegurar que exista el ancla
(function(){
  var _origSet = (typeof setFacturaStatus === 'function') ? setFacturaStatus : null;
  window.setFacturaStatus = function(kind, text, withSpinner){
    var el = document.getElementById('facturaStatus') || ensureFacturaStatusAnchor();
    if(!el) return;
    el.className = 'factura-status ' + (kind || 'mute');
    el.innerHTML = (withSpinner ? '<span class="spin" aria-hidden="true"></span>' : '') +
                   '<span>' + (text || '') + '</span>';
  };
})();

// Asegurar creación del ancla tempranamente
document.addEventListener('DOMContentLoaded', ensureFacturaStatusAnchor);
</script>

</body>
</html>
