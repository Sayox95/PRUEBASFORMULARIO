<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reporte de Gastos de Combustible</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
  <script defer src="https://unpkg.com/blueimp-load-image/js/load-image.all.min.js"></script>
  <style>
    :root{--space:clamp(.75rem,2.5vw,1rem);--space-lg:clamp(1rem,3.5vw,1.25rem);--radius:12px;--muted:#c9d3e0;--text:#eaf0f8;--primary:#4c9ffe;--danger:#ff5d7a}
    *{box-sizing:border-box}
    body{margin:0;font-family:Roboto,system-ui,-apple-system,Segoe UI,sans-serif;color:var(--text);background:#0b1020;padding:var(--space)}
    header{max-width:1024px;margin:0 auto var(--space-lg)}
    h1{font-size:clamp(1.25rem,3.5vw,1.75rem);margin:0 0 .25rem}
    p.sub{color:var(--muted);margin:0}
    .app{max-width:1024px;margin:0 auto;display:grid;gap:var(--space-lg)}
    .card{background:#0f172a;border:1px solid #2a3a5a;border-radius:var(--radius);padding:var(--space-lg)}
    .grid{display:grid;gap:var(--space)}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:900px){.grid.cols-3{grid-template-columns:1fr}}
    @media (max-width:700px){.grid.cols-2{grid-template-columns:1fr}}
    label{font-weight:600;display:block;margin-bottom:.35rem}
    input,select,textarea,button{width:100%;font-size:clamp(16px,2.6vw,18px);color:var(--text);background:#0f1525;border:1px solid #223052;border-radius:.75rem;padding:.85rem 1rem;outline:none}
    input::placeholder,textarea::placeholder{color:#8aa0bc}
    input:focus-visible,select:focus-visible,textarea:focus-visible,button:focus-visible{outline:3px solid var(--primary);outline-offset:2px}
    select{appearance:none;background-image:linear-gradient(45deg,transparent 50%,var(--muted) 50%),linear-gradient(135deg,var(--muted) 50%,transparent 50%);background-position:calc(100% - 20px) calc(1.1em),calc(100% - 15px) calc(1.1em);background-size:5px 5px,5px 5px;background-repeat:no-repeat}
    .actions{display:flex;gap:.75rem;flex-wrap:wrap}
    .btn{cursor:pointer;border-radius:999px;padding:.9rem 1.25rem;border:1px solid #2d3b5a;font-weight:600;background:#0b1222}
    .btn.primary{background:#225ad6;color:#eaf0f8;border-color:#1c4bb3}
    .btn.ok{background:#0fa86b;border-color:#118a59}
    .btn.danger{background:#ff476a;border-color:#e33e5d}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .error{color:var(--danger);font-size:.9rem;margin-top:.25rem;min-height:1.1em}
    .previewWrap{border-radius:var(--radius);overflow:clip;border:1px solid #213154}
    #previewFrame{width:100%;height:min(75vh,900px);display:block;border:0;background:#0a0f1e}
    #previewFallback{padding:var(--space)}
    #pdfJsContainer{background:#f4f5f7; padding:12px; display:block;}
    .pdfjs-page{display:block;margin:0 auto 12px;max-width:100%;height:auto;image-rendering:-webkit-optimize-contrast;image-rendering:crisp-edges;}
    .thumbs{display:grid;gap:var(--space);grid-template-columns:repeat(auto-fill,minmax(180px,1fr))}
    .thumb{border:1px dashed #335084;border-radius:.75rem;padding:.5rem;background:#0f172a;min-height:160px;display:grid;place-items:center}
    .thumb img{max-width:100%;height:auto;object-fit:contain;display:block}
    .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#0f2a1f;border:1px solid #1c7d57;color:#c8ffe7;padding:.85rem 1rem;border-radius:.75rem;box-shadow:0 10px 20px rgba(0,0,0,.35);display:none;z-index:50}
    @media print{@page{size:letter;margin:1.27cm}body{background:#fff;color:#000}.no-print{display:none !important}}
  </style>
</head>
<body>
  <header class="no-print">
    <h1>Reporte de Gastos de Combustible</h1>
    <p class="sub">Completa el formulario, previsualiza el PDF y envíalo. Compatible con móvil.</p>
  </header>
  <main class="app">
    <section class="card" aria-labelledby="formTitle">
      <h2 id="formTitle" style="margin-top:0">Formulario</h2>
      <form id="form" novalidate class="grid">
        <div class="grid cols-3">
          <div>
            <label for="sector">Sector</label>
            <select id="sector" name="sector" required disabled>
              <option value="">Cargando…</option>
            </select>
            <div class="error" id="err_sector"></div>
          </div>
          <div>
            <label for="proceso">Proceso</label>
            <input id="proceso" name="proceso" placeholder="Ej. Recolección" required />
            <div class="error" id="err_proceso"></div>
          </div>
          <div>
            <label for="placa">Placa</label>
            <select id="placa" name="placa" required disabled>
              <option value="">Selecciona…</option>
            </select>
            <div class="error" id="err_placa"></div>
          </div>
        </div>
        <div class="grid cols-3">
          <div>
            <label for="nombre">Nombre</label>
            <input id="nombre" name="nombre" placeholder="Nombre completo" required />
            <div class="error" id="err_nombre"></div>
          </div>
          <div>
            <label for="identidad">Identidad</label>
            <input id="identidad" name="identidad" placeholder="0000-0000-00000" required pattern="\d{4}-\d{4}-\d{5}" />
            <div class="error" id="err_identidad"></div>
          </div>
          <div>
            <label for="jefe">Jefe inmediato</label>
            <input id="jefe" name="jefe" placeholder="Nombre jefe" readonly />
            <div class="error" id="err_jefe"></div>
          </div>
        </div>
        <div class="grid cols-3">
          <div>
            <label for="fecha">Fecha</label>
            <input id="fecha" name="fecha" type="date" required />
            <div class="error" id="err_fecha"></div>
          </div>
          <div>
            <label for="horas">Horas del viaje</label>
            <input id="horas" name="horas" type="number" min="0" step="0.1" required />
            <div class="error" id="err_horas"></div>
          </div>
          <div>
            <label for="km">Km actual</label>
            <input id="km" name="km" type="number" min="0" step="1" required />
            <div class="error" id="err_km"></div>
          </div>
        </div>
        <div class="grid cols-3">
          <div>
            <label for="total">Total gastado (moneda)</label>
            <input id="total" name="total" type="number" min="0" step="0.01" required />
            <div class="error" id="err_total"></div>
          </div>
          <div>
            <label for="litros">Litros consumidos</label>
            <input id="litros" name="litros" type="number" min="0" step="0.01" required />
            <div class="error" id="err_litros"></div>
          </div>
          <div>
            <label for="motivo">Motivo del llenado</label>
            <input id="motivo" name="motivo" placeholder="Ej. Ruta diaria" required />
            <div class="error" id="err_motivo"></div>
          </div>
        </div>
        <div class="grid cols-3">
          <div>
            <label for="factura">Número de factura</label>
            <input id="factura" name="factura" required />
            <div class="error" id="err_factura"></div>
          </div>
          <div>
            <label for="nombre_comercio">Nombre del comercio</label>
            <input id="nombre_comercio" name="nombre_comercio" required />
            <div class="error" id="err_nombre_comercio"></div>
          </div>
          <div>
            <label for="sector_lista">Sector (lista opcional)</label>
            <select id="sector_lista" name="sector_lista">
              <option value="">Selecciona…</option>
              <option>Norte</option>
              <option>Sur</option>
              <option>Este</option>
              <option>Oeste</option>
            </select>
          </div>
        </div>
        <hr style="border-color:#223052;opacity:.5" />
        <div class="grid cols-3">
          <div>
            <label for="foto_tablero_antes">Foto tablero antes</label>
            <input id="foto_tablero_antes" type="file" accept="image/*" capture="environment" required />
            <div class="error" id="err_foto_tablero_antes"></div>
          </div>
          <div>
            <label for="foto_bomba">Foto bomba/contador</label>
            <input id="foto_bomba" type="file" accept="image/*" capture="environment" required />
            <div class="error" id="err_foto_bomba"></div>
          </div>
          <div>
            <label for="foto_despues">Foto tablero después</label>
            <input id="foto_despues" type="file" accept="image/*" capture="environment" required />
            <div class="error" id="err_foto_despues"></div>
          </div>
        </div>
        <div class="grid cols-3">
          <div>
            <label for="foto_bomba_llenado">Foto bomba llenado</label>
            <input id="foto_bomba_llenado" type="file" accept="image/*" capture="environment" required />
            <div class="error" id="err_foto_bomba_llenado"></div>
          </div>
          <div>
            <label for="foto_frontal">Foto frontal vehículo</label>
            <input id="foto_frontal" type="file" accept="image/*" capture="environment" required />
            <div class="error" id="err_foto_frontal"></div>
          </div>
          <div>
            <label for="foto_factura">Foto factura</label>
            <input id="foto_factura" type="file" accept="image/*" capture="environment" required />
            <div class="error" id="err_foto_factura"></div>
          </div>
        </div>
        <div class="thumbs">
          <div class="thumb" id="preview_foto_tablero_antes"><span>Preview tablero antes</span></div>
          <div class="thumb" id="preview_foto_bomba"><span>Preview bomba</span></div>
          <div class="thumb" id="preview_foto_despues"><span>Preview tablero después</span></div>
          <div class="thumb" id="preview_foto_bomba_llenado"><span>Preview bomba llenado</span></div>
          <div class="thumb" id="preview_foto_frontal"><span>Preview frontal</span></div>
          <div class="thumb" id="preview_foto_factura"><span>Preview factura</span></div>
        </div>
        <div class="actions">
          <button type="button" class="btn" id="btnPreview" disabled>Generar vista previa</button>
          <button type="button" class="btn primary" id="btnEnviar" disabled>Enviar y descargar PDF</button>
          <button type="reset" class="btn danger">Limpiar</button>
        </div>
      </form>
    </section>

    <section class="card no-print" aria-labelledby="prevTitle">
      <h2 id="prevTitle" style="margin-top:0">Vista previa del PDF</h2>
      <div class="previewWrap">
        <iframe id="previewFrame" title="Vista previa del PDF"></iframe>
        <div id="pdfJsContainer" hidden></div>
        <div id="previewFallback" hidden>
          <p>Tu navegador no puede mostrar el PDF embebido.</p>
          <div class="actions">
            <button id="btnAbrirPdf" class="btn">Abrir</button>
            <a id="linkDescargarPdf" class="btn ok" download>Descargar PDF</a>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite">Listo</div>

  <script>
    const ImageState = {};
    const urlGuardarReporte = '/api/guardar';
    const Catalogos = { sectores: [], placasPorSector: {}, jefePorSector: {} };
    const urlCatalogos = 'https://script.google.com/macros/s/AKfycbxp2yVp4hF-t9f2LdU9NhZxVt6RwXyL3uKrKzXk4a_l4na2Rkd1LZMB02pEJeRQ_eCF/exec';
    function setSelectOptions(sel, arr, placeholder='Selecciona…'){
      if(!sel) return;
      const opts = ['<option value="">'+placeholder+'</option>'].concat((arr||[]).map(v=>'<option>'+String(v)+'</option>'));
      sel.innerHTML = opts.join('');
    }
    async function cargarCatalogos(){
      const selSector = document.getElementById('sector');
      const selPlaca = document.getElementById('placa');
      if (selSector) selSector.disabled = true;
      if (selPlaca) selPlaca.disabled = true;
      try{
        const res = await fetch(urlCatalogos, { method: 'GET', mode: 'cors' });
        const json = await res.json();
        if (Array.isArray(json)){
          const setSect = new Set();
          const placasPorSector = {};
          const jefePorSector = {};
          for (const row of json){
            const placa = (row && row.PLACA ? String(row.PLACA).trim() : '');
            const sector = (row && row.Sector ? String(row.Sector).trim() : '');
            const jefe = (row && row['Jefe inmediato'] ? String(row['Jefe inmediato']).trim() : '');
            if (!placa || !sector) continue;
            setSect.add(sector);
            (placasPorSector[sector] = placasPorSector[sector] || []).push(placa);
            if (jefe && !jefePorSector[sector]) jefePorSector[sector] = jefe;
          }
          Catalogos.sectores = Array.from(setSect).sort();
          Catalogos.placasPorSector = placasPorSector;
          Catalogos.jefePorSector = jefePorSector;
          setSelectOptions(selSector, Catalogos.sectores, 'Selecciona…');
          if (selSector) selSector.disabled = false;
        }
      }catch(e){ console.error('Catálogos:', e); }
    }
    function onSectorChange(){
      const selSector = document.getElementById('sector');
      const selPlaca = document.getElementById('placa');
      const jefeInput = document.getElementById('jefe');
      const sector = selSector ? selSector.value : '';
      const placas = (Catalogos.placasPorSector[sector] || []).slice().sort();
      setSelectOptions(selPlaca, placas, 'Selecciona…');
      if (selPlaca) selPlaca.disabled = placas.length===0;
      if (jefeInput) jefeInput.value = Catalogos.jefePorSector[sector] || '';
    }
    let lastBlobUrl = null;

    function showToast(msg='Hecho'){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; clearTimeout(showToast._timer); showToast._timer=setTimeout(()=>{t.style.display='none'},2500); }
    function setBusy(isBusy){ document.querySelectorAll('button').forEach(b=>b.disabled=!!isBusy); }

    function pdfEmbedPodriaFallar(){
      const ua = navigator.userAgent || navigator.vendor || '';
      const iOS = /iPad|iPhone|iPod/i.test(ua);
      const isSafari = /^((?!chrome|android).)*safari/i.test(ua);
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);
      return (iOS && isSafari) || isMobile;
    }

    function trimUpper(v){ return (v||'').trim().toUpperCase(); }
    function trimAny(v){ return (v||'').trim(); }
    function showError(input, text){ const e=document.getElementById('err_'+input.id); if(e) e.textContent=text||''; }

    function validateForm(){
      let ok=true;
      document.querySelectorAll('#form [required]').forEach(inp=>{ if(!inp.checkValidity()){ ok=false; showError(inp, inp.validationMessage); } else { showError(inp,''); } });
      const fileIds=['foto_tablero_antes','foto_bomba','foto_despues','foto_bomba_llenado','foto_frontal','foto_factura'];
      for(const id of fileIds){ const el=document.getElementById(id); if(!el.files||!el.files[0]){ ok=false; showError(el,'Requerido'); continue; } const file=el.files[0]; const isRecent=(Date.now()-file.lastModified)<=48*3600*1000; if(!isRecent){ ok=false; showError(el,'La foto debe ser ≤ 48 horas'); } }
      return ok;
    }

    const SUPPORTED_IMAGE_TYPES = new Set(['image/jpeg','image/png','image/webp']);
    function readFileAsDataURL(file){ return new Promise((resolve,reject)=>{ const fr=new FileReader(); fr.onload=()=>resolve(fr.result); fr.onerror=()=>reject(fr.error||new Error('FileReader')); fr.readAsDataURL(file); }); }
    function drawToCanvas(imgLike,maxW,maxH){ const iw=imgLike.naturalWidth||imgLike.width; const ih=imgLike.naturalHeight||imgLike.height; const r=Math.min(maxW/iw,maxH/ih,1); const tw=Math.max(1,Math.round(iw*r)); const th=Math.max(1,Math.round(ih*r)); const c=document.createElement('canvas'); c.width=tw; c.height=th; const ctx=c.getContext('2d'); ctx.drawImage(imgLike,0,0,tw,th); return c; }
    async function fileToOptimizedBase64(file,maxW=1600,maxH=1600,quality=0.7){ if(!file) throw new Error('Archivo inválido'); if(!SUPPORTED_IMAGE_TYPES.has(file.type)){ const err=new Error('Formato no soportado'); err.code='UNSUPPORTED_FORMAT'; err.type=file.type||'unknown'; throw err; } const dataUrl=await readFileAsDataURL(file); const img=pdfMake.createPdf(dd).download(filename); renderPdfPreview(dd); showProgress('Guardando información...'); setProgress(20); await new Promise((resolve,reject)=>{ pdfMake.createPdf(dd).getBase64(async(b64)=>{ try{ setProgress(60); const resp=await postJSONWithRetry(urlGuardarReporte,{...data,pdf:b64,filename},1,20000); setProgress(90); console.log('Backend respondió:',resp); resolve(); } catch(err){ reject(err); } }); }); hideProgress('Información enviada correctamente'); } catch(e){ alert('Error al guardar el reporte. Inténtalo de nuevo.'); } finally { setBusy(false); } }

    document.getElementById('btnPreview')?.addEventListener('click',schedulePreview);
    document.getElementById('btnEnviar')?.addEventListener('click',enviarReporte);
    ;['sector','sector_lista','proceso','placa','nombre','identidad','fecha','horas','km','total','litros','motivo','factura','nombre_comercio','jefe'].forEach(id=>document.getElementById(id)?.addEventListener('change',schedulePreview));

    window.addEventListener('DOMContentLoaded',()=>{ const qp=new URLSearchParams(location.search); if(qp.get('test')==='1'){ /* reserved */ } });
    window.addEventListener('load', async ()=>{
      try{
        await waitForPdfMake();
        await cargarCatalogos();
        const btnPrev = document.getElementById('btnPreview');
        const btnEnv = document.getElementById('btnEnviar');
        if (btnPrev) btnPrev.disabled=false;
        if (btnEnv) btnEnv.disabled=false;
        document.getElementById('sector')?.addEventListener('change', onSectorChange);
      }catch(e){}
    });
    window.addEventListener('beforeunload',()=>{ if(lastBlobUrl) URL.revokeObjectURL(lastBlobUrl); });
  </script>
</body>
</html>
